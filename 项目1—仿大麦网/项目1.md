# 数据库和表结构

## 项目中是否进行了分库分表

使用了**Shardingsphere**中间件进行了**垂直分库**（按照不同的业务进行拆分）+ **水平分库**（每个业务内进行拆分）+ **水平分表**



## 为什么在用户表外额外设计用户手机表和用户邮箱表？

![密码登录.jpg](https://cdn.nlark.com/yuque/0/2024/jpeg/22643320/1723691960114-1045b61f-03f3-455d-afa0-5e959558738f.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6Zi_5pif5LiN5piv56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

用户登录时，可以用手机号或邮箱登录，也就是需要用手机号和邮箱来查询用户信息；而在订单业务中需要用用户id查询用户信息。分库分表使用的是用户id作为分片键，使用手机号 和 邮箱查询用户信息会造成**全路由问题**。



**解决方案：**

![用户登录.png](https://cdn.nlark.com/yuque/0/2024/png/22643320/1723691907122-269cd4f3-d201-4759-aeeb-becaaad43b54.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6Zi_5pif5LiN5piv56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

为了解决这个全路由问题，采用附属表方案，设置了用户手机表和用户邮箱表，分片键是手机号和邮箱，先通过手机号或邮箱查询到用户id，然后使用用户id查询用户表，这样就解决了问题。



**缺点：**

- 多了一步查询的过程，额外产生了性能的消耗
- 额外多了用户手机表和用户邮箱表，随着数据量的越来越大，表容量的占用也越来越大



## 项目中哪里使用了基因法

在订单业务中，即需要根据用户id查询订单，又需要根据订单号查询订单

假设分片数是N，用用户id的后$log_2N$位替换掉订单号的后$log_2N$位，二者对N的取模的结果相同。

- 可以保证一个用户所有订单号一定会分片同一个库和表中
- 通过该用户的id或订单号都可以直接定位到这张表上，不需要全路由



假设存在一种情况，在超高的并发下，在同一毫秒，同一台机器，生成两个id，那么这两个id唯一的区别就是序列号相差1，如果这时我们使用了基因法，那么这两个id不就重复了吗？

- 确需要用户在同一毫秒下创建了2个订单才能重复，要是正常的用户肯定是不会重复的，除非是机器刷单或者恶意攻击这种情况











# 网关服务



# 用户服务



# 节目服务



# 订单服务



# 支付服务



