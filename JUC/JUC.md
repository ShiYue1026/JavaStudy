# JUCåŸºç¡€

## åˆ›å»ºçº¿ç¨‹çš„ä¸‰ç§æ–¹æ³•

**1. Thread**

- ç»§æ‰¿Threadç±»ï¼Œé‡å†™`run()`æ–¹æ³•ï¼Œè°ƒç”¨`start()`æ–¹æ³•å¯åŠ¨çº¿ç¨‹

**2. Runnable**

- å®ç°Runnableæ¥å£ï¼Œé‡å†™`run()`æ–¹æ³•ï¼Œå°†Runnableå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™Threadå¯¹è±¡ï¼Œè°ƒç”¨start()æ–¹æ³•å¯åŠ¨çº¿ç¨‹

**3.FutureTask**

- å®ç°Callableæ¥å£ï¼Œé‡å†™`call()`æ–¹æ³•ï¼Œç„¶ååˆ›å»ºFutureTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºCallableå¯¹è±¡ï¼›ç„¶ååˆ›å»ºThreadå¯¹è±¡ï¼Œå‚æ•°ä¸ºFutureTaskå¯¹è±¡ï¼ˆå› ä¸ºFutureTaskç»§æ‰¿äº†Runnableæ¥å£ï¼‰ï¼Œè°ƒç”¨`start()`æ–¹æ³•å¯åŠ¨çº¿ç¨‹

```java
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.FutureTask;

public class CallableExample {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        // åˆ›å»º Callable ä»»åŠ¡
        Callable<Integer> task = () -> {
            System.out.println(Thread.currentThread().getName() + " æ‰§è¡Œä»»åŠ¡...");
            Thread.sleep(2000);
            return 42; // è¿”å›è®¡ç®—ç»“æœ
        };

        // ç”¨ FutureTask åŒ…è£… Callable
        FutureTask<Integer> futureTask = new FutureTask<>(task);

        // åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨
        Thread thread = new Thread(futureTask);
        thread.start();

        // è·å–ç»“æœï¼ˆé˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆï¼‰
        Integer result = futureTask.get();
        System.out.println("ä»»åŠ¡æ‰§è¡Œç»“æœï¼š" + result);
    }
}
```



## å¯¹çº¿ç¨‹å®‰å…¨çš„ç†è§£

**1. åŸå­æ€§**

- ç¡®ä¿å½“æŸä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡æ—¶ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥åŒæ—¶ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå³è¿™ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ã€‚

**2. å¯è§æ€§**

- ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¯ä»¥ç«‹å³è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚

3.**æ´»è·ƒæ€§**

- è¦ç¡®ä¿çº¿ç¨‹ä¸ä¼šå› ä¸ºæ­»é”ã€é¥¥é¥¿ã€æ´»é”ç­‰é—®é¢˜å¯¼è‡´æ— æ³•ç»§ç»­æ‰§è¡Œã€‚



## è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«

**è¿›ç¨‹**ï¼šæ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½

**çº¿ç¨‹**ï¼šæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦çš„æœ€å°å•ä½ã€‚å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªè¿›ç¨‹çš„èµ„æºï¼Œå¦‚å†…å­˜ï¼›æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆå’Œå¯„å­˜å™¨ã€‚



## çº¿ç¨‹çš„å…±äº«å†…å­˜

æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå­˜æ”¾çº¿ç¨‹ç§æœ‰å˜é‡å’Œä»ä¸»å†…å­˜æ‹·è´çš„å…±äº«å˜é‡å‰¯æœ¬ã€‚



Javaä¸­é‡‡å–å…±äº«å†…å­˜çš„æ–¹å¼å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚

çº¿ç¨‹ A ä¸çº¿ç¨‹ B ä¹‹é—´å¦‚è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š

- çº¿ç¨‹ A æŠŠæœ¬åœ°å†…å­˜ A ä¸­çš„å…±äº«å˜é‡å‰¯æœ¬åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚
- çº¿ç¨‹ B åˆ°ä¸»å†…å­˜ä¸­è¯»å–çº¿ç¨‹ A åˆ·æ–°è¿‡çš„å…±äº«å˜é‡ï¼Œå†åŒæ­¥åˆ°è‡ªå·±çš„å…±äº«å˜é‡å‰¯æœ¬ä¸­ã€‚

![æ·±å…¥æµ…å‡º Java å¤šçº¿ç¨‹ï¼šçº¿ç¨‹é—´é€šä¿¡](https://cdn.tobebetterjavaer.com/stutymore/javathread-20240315111130.png)



## å¯åŠ¨ä¸€ä¸ªJavaç¨‹åºé‡Œé¢æœ‰å“ªäº›çº¿ç¨‹

**1. mainä¸»çº¿ç¨‹**ï¼šç¨‹åºå¼€å§‹æ‰§è¡Œçš„å…¥å£

**2. åƒåœ¾å›æ”¶çº¿ç¨‹**ï¼šåå°çº¿ç¨‹ï¼Œè´Ÿè´£å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡

**3. ç¼–è¯‘å™¨çº¿ç¨‹**ï¼šåœ¨åŠæ—¶ç¼–è¯‘ä¸­ï¼ˆJITï¼‰ï¼Œè´Ÿè´£æŠŠä¸€éƒ¨åˆ†çƒ­ç‚¹ä»£ç ç¼–è¯‘åæ”¾åˆ° codeCache ä¸­ï¼Œä»¥æå‡ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚



## start()å’Œrun()çš„åŒºåˆ«

- å½“è°ƒç”¨`start()`æ–¹æ³•æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶è®©è¿™ä¸ªæ–°çº¿ç¨‹è°ƒç”¨`run()`æ–¹æ³•ã€‚

- å¦‚æœç›´æ¥è°ƒç”¨`run()`æ–¹æ³•ï¼Œé‚£ä¹ˆ`run()`æ–¹æ³•å°±åœ¨å½“å‰çº¿ç¨‹ä¸­è¿è¡Œï¼Œæ²¡æœ‰æ–°çš„çº¿ç¨‹è¢«åˆ›å»ºï¼Œä¹Ÿå°±æ²¡æœ‰å®ç°å¤šçº¿ç¨‹çš„æ•ˆæœã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šstartæ–¹æ³•](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-5.png)

## çº¿ç¨‹æœ‰å“ªäº›å¸¸ç”¨çš„è°ƒåº¦æ–¹æ³•

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šçº¿ç¨‹å¸¸ç”¨è°ƒåº¦æ–¹æ³•](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-6.png)

`yield()`ï¼šThread ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ yield æ–¹æ³•æ—¶ï¼Œå®é™…æ˜¯åœ¨æš—ç¤ºçº¿ç¨‹è°ƒåº¦å™¨ï¼Œå½“å‰çº¿ç¨‹è¯·æ±‚è®©å‡ºè‡ªå·±çš„ CPUï¼ˆä¸ä¼šé‡Šæ”¾é”ï¼‰ï¼Œä½†æ˜¯çº¿ç¨‹è°ƒåº¦å™¨å¯èƒ½ä¼šâ€œè£…çœ‹ä¸è§â€å¿½ç•¥è¿™ä¸ªæš—ç¤ºã€‚



## interrupt()å’Œstop()çš„åŒºåˆ«

`interrupt()`

- `interrupt()` åªæ˜¯å‘çº¿ç¨‹å‘é€ä¸€ä¸ª â€œä¸­æ–­è¯·æ±‚â€ï¼Œä½†ä¸ä¼šçœŸæ­£ç»ˆæ­¢çº¿ç¨‹ã€‚çº¿ç¨‹å¯ä»¥è‡ªå·±å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œä¸€èˆ¬é€šè¿‡æ£€æŸ¥ `Thread.interrupted()` æˆ–æ•è· `InterruptedException`ã€‚

`stop()`

- å¼ºåˆ¶åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œï¼Œæ— è®ºçº¿ç¨‹å½“å‰å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚
- å·²åºŸå¼ƒï¼Œä¸å®‰å…¨



## çº¿ç¨‹çŠ¶æ€

**æ“ä½œç³»ç»Ÿå±‚é¢ï¼ˆ5ç§çŠ¶æ€ï¼‰**

- åˆå§‹çŠ¶æ€
- å¯è¿è¡ŒçŠ¶æ€
- è¿è¡ŒçŠ¶æ€
- é˜»å¡çŠ¶æ€
- ç»ˆæ­¢çŠ¶æ€

**Javaå±‚é¢ï¼ˆ6ç§çŠ¶æ€ï¼‰**

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šJavaçº¿ç¨‹çŠ¶æ€å˜åŒ–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-7.png)

- NEW
- RUNNABLEï¼šåŒ…å«æ“ä½œç³»ç»Ÿå±‚é¢çš„ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘
- BLOCKEDï¼šå¦‚æ²¡æŠ¢åˆ°synchronizedçš„é”
- WAITINGï¼šjoin()ã€wait()ï¼Œéœ€è¦å…¶ä»–çº¿ç¨‹æ˜¾å¼å”¤é†’
- TIMED_WAITINGï¼šwait(1000)ã€sleep(1000)
- TERMINATED



## ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

**ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š**CPU èµ„æºçš„åˆ†é…é‡‡ç”¨äº†æ—¶é—´ç‰‡è½®è½¬ä¹Ÿå°±æ˜¯ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹åœ¨æ—¶é—´ç‰‡å†…å ç”¨ CPU æ‰§è¡Œä»»åŠ¡ã€‚å½“çº¿ç¨‹ä½¿ç”¨å®Œæ—¶é—´ç‰‡åï¼Œå°±ä¼šå¤„äºå°±ç»ªçŠ¶æ€å¹¶è®©å‡º CPU è®©å…¶ä»–çº¿ç¨‹å ç”¨



å½“ CPU éœ€è¦ä»çº¿ç¨‹ A åˆ‡æ¢åˆ°çº¿ç¨‹ B æ—¶ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š

1. ä¿å­˜çº¿ç¨‹ A çš„ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ï¼š
   - å¯„å­˜å™¨ï¼ˆRegistersï¼‰ï¼ˆåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ PCï¼‰
   - æ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼‰
   - ç¨‹åºçŠ¶æ€å­—ï¼ˆProgram Status Word, PSWï¼‰
   - CPU ç¼“å­˜ï¼ˆéƒ¨åˆ†å¯èƒ½å¤±æ•ˆï¼‰
2. åŠ è½½çº¿ç¨‹ B çš„ä¸Šä¸‹æ–‡ï¼Œæ¢å¤å…¶ä¹‹å‰çš„æ‰§è¡ŒçŠ¶æ€ã€‚
3. CPU é‡æ–°æ‰§è¡Œçº¿ç¨‹ Bã€‚

è¿™ä¸ªåˆ‡æ¢è¿‡ç¨‹éœ€è¦ æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰å†…æ ¸ ä»‹å…¥ï¼Œæ¶‰åŠå†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„è½¬æ¢ï¼Œå› æ­¤ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯æœ‰å¼€é”€çš„ã€‚



## ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹

Javaä¸­çº¿ç¨‹åˆ†ä¸ºä¸¤ç±»ï¼š**å®ˆæŠ¤çº¿ç¨‹**ã€**ç”¨æˆ·çº¿ç¨‹**

- å®ˆæŠ¤çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸé—´æ¥ä¾èµ–ç”¨æˆ·çº¿ç¨‹ï¼Œå¦‚æœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½ç»“æŸäº†ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè‡ªåŠ¨ç»ˆæ­¢ï¼ŒJVM é€€å‡ºã€‚å®ˆæŠ¤çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨ä¾èµ–äº JVM çš„è¿è¡ŒçŠ¶æ€ã€‚
- å®ˆæŠ¤çº¿ç¨‹ä¸€èˆ¬ç”¨äºåå°æœåŠ¡ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹ç­‰ã€‚
- ç”¨æˆ·çº¿ç¨‹æ˜¯ Java åº”ç”¨ç¨‹åºçš„ä¸»æ‰§è¡Œçº¿ç¨‹ï¼ŒJVM åªæœ‰åœ¨æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šé€€å‡ºã€‚



## çº¿ç¨‹ä¹‹é—´æœ‰å“ªäº›é€šä¿¡æ–¹å¼

**1. ä½¿ç”¨å…±äº«å¯¹è±¡**

- volatile
- synchronized

**2. ä½¿ç”¨wait()å’Œnotify()**

**3. ä½¿ç”¨ Exchanger**

- ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `exchange()` æ–¹æ³•ï¼Œå°†æ•°æ®ä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶æ¥æ”¶å¦ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®ã€‚

**4.ä½¿ç”¨ CompletableFuture**

```java
import java.util.concurrent.*;

public class CompletableFutureExample {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        CompletableFuture<String> future = new CompletableFuture<>();

        // çº¿ç¨‹1ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œå¹¶åœ¨å®Œæˆåé€šçŸ¥ä¸»çº¿ç¨‹
        new Thread(() -> {
            try {
                Thread.sleep(2000); // æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡
                future.complete("ä»»åŠ¡å®Œæˆï¼"); // é€šçŸ¥ CompletableFuture
            } catch (InterruptedException e) {
                future.completeExceptionally(e); // å‘ç”Ÿå¼‚å¸¸æ—¶é€šçŸ¥
            }
        }).start();

        // çº¿ç¨‹2ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼šç­‰å¾… future å®Œæˆ
        System.out.println("ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡...");
        String result = future.get(); // é˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆ
        System.out.println("æ”¶åˆ°å­çº¿ç¨‹æ¶ˆæ¯ï¼š" + result);
    }
}
```

ä¸»çº¿ç¨‹ `future.get()` é˜»å¡ç­‰å¾…ï¼Œç›´åˆ° å­çº¿ç¨‹è°ƒç”¨ `future.complete()` é€šçŸ¥å®Œæˆï¼Œä¸»çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œã€‚



## sleep()å’Œwait()çš„åŒºåˆ«

**é”è¡Œä¸ºä¸åŒ**

- å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰æŸä¸ªå¯¹è±¡çš„é”æ—¶è°ƒç”¨äº† sleepï¼Œå®ƒåœ¨ç¡çœ æœŸé—´ä»ç„¶ä¼šæŒæœ‰è¿™ä¸ªé”ã€‚
- å½“çº¿ç¨‹æ‰§è¡Œ wait æ–¹æ³•æ—¶ï¼Œå¿…é¡»æ‹¥æœ‰é”ï¼Œå®ƒä¼šé‡Šæ”¾å®ƒæŒæœ‰çš„é‚£ä¸ªå¯¹è±¡çš„é”ï¼Œè¿™ä½¿å¾—å…¶ä»–çº¿ç¨‹å¯ä»¥æœ‰æœºä¼šè·å–è¯¥å¯¹è±¡çš„é”

**ä½¿ç”¨æ¡ä»¶ä¸åŒ**

- `sleep()` æ–¹æ³•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¢«è°ƒç”¨ã€‚
- `wait()` æ–¹æ³•å¿…é¡»åœ¨åŒæ­¥ä»£ç å—æˆ–åŒæ­¥æ–¹æ³•ä¸­è¢«è°ƒç”¨

**å”¤é†’æ–¹å¼ä¸åŒ**

- è°ƒç”¨ sleep æ–¹æ³•åï¼Œçº¿ç¨‹ä¼šè¿›å…¥ TIMED_WAITING çŠ¶æ€ï¼ˆå®šæ—¶ç­‰å¾…çŠ¶æ€ï¼‰ï¼Œå³åœ¨æŒ‡å®šçš„æ—¶é—´å†…æš‚åœæ‰§è¡Œã€‚å½“æŒ‡å®šçš„æ—¶é—´ç»“æŸåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨æ¢å¤åˆ° RUNNABLE çŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰ï¼Œç­‰å¾… CPU è°ƒåº¦å†æ¬¡æ‰§è¡Œã€‚
- è°ƒç”¨ wait æ–¹æ³•åï¼Œçº¿ç¨‹ä¼šè¿›å…¥ WAITING çŠ¶æ€ï¼ˆæ— é™æœŸç­‰å¾…çŠ¶æ€ï¼‰ï¼Œç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹åœ¨åŒä¸€å¯¹è±¡ä¸Šè°ƒç”¨ notify æˆ– notifyAllï¼Œçº¿ç¨‹æ‰ä¼šä» WAITING çŠ¶æ€è½¬å˜ä¸º RUNNABLE çŠ¶æ€ï¼Œå‡†å¤‡å†æ¬¡è·å¾— CPU çš„æ‰§è¡Œæƒã€‚



# é”

## Synchronizedé”ä½çš„æ˜¯ä»€ä¹ˆ

synchronizedæ˜¯**åŸºäºMonitorå®ç°**çš„ã€‚

å®ä¾‹å¯¹è±¡ç»“æ„é‡Œæœ‰å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´é‡Œé¢æœ‰ä¸€å—ç»“æ„å« Mark Wordï¼ŒMark Word æŒ‡é’ˆæŒ‡å‘äº†**Monitor**ã€‚

![Java Montioræœºåˆ¶](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-33.png)

**EntrySet**æŒ‡çš„æ˜¯ ç­‰å¾…è·å–é”çš„çº¿ç¨‹é˜Ÿåˆ—ã€‚å½“çº¿ç¨‹å°è¯•è·å–é”ä½†å¤±è´¥æ—¶ï¼Œå®ƒä»¬ä¼šè¿›å…¥EntrySetè¿›è¡Œæ’é˜Ÿï¼Œç­‰å¾…é”çš„é‡Šæ”¾ã€‚

**WaitSet**æŒ‡çš„æ˜¯ çº¿ç¨‹è°ƒç”¨ `Object.wait()` ä¹‹åè¿›å…¥çš„ç­‰å¾…é˜Ÿåˆ—ã€‚è¿™äº›çº¿ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸ªçº¿ç¨‹è°ƒç”¨ `notify()` æˆ– `notifyAll()` å”¤é†’å®ƒä»¬ã€‚



## Synchronizedä¼šç‰µæ‰¯åˆ°æ“ä½œç³»ç»Ÿå±‚é¢å—

Synchronized å‡çº§ä¸ºé‡é‡çº§é”æ—¶ï¼Œä¾èµ–äºæ“ä½œç³»ç»Ÿçš„äº’æ–¥é‡ï¼ˆmutexï¼‰æ¥å®ç°ï¼Œmutex ç”¨äºä¿è¯ä»»ä½•ç»™å®šæ—¶é—´å†…ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸€æ®µç‰¹å®šçš„ä»£ç æ®µ



## Synchronizedæ€ä¹ˆä¿è¯å¯è§æ€§ã€æœ‰åºæ€§ã€å¯é‡å…¥

**å¯è§æ€§**

- çº¿ç¨‹åŠ é”å‰ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼
- çº¿ç¨‹åŠ é”åï¼Œå…¶å®ƒçº¿ç¨‹æ— æ³•è·å–ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡
- çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­



**æœ‰åºæ€§**

- synchronizedä¿è¯é¡ºåºæ€§æ˜¯æŒ‡çš„å°†å¹¶å‘æ‰§è¡Œå˜æˆäº†ä¸²è¡Œï¼ŒåŒä¸€æ—¶åˆ»ä»£ç æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯å†…éƒ¨æŒ‡ä»¤é‡æ’åºé—®é¢˜
- å› ä¸º as-if-serial è¯­ä¹‰çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„ç¨‹åºèƒ½ä¿è¯æœ€ç»ˆç»“æœæ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ä¸ä¿è¯ä¸ä¼šæŒ‡ä»¤é‡æ’



**å¯é‡å…¥**

- synchronized ä¹‹æ‰€ä»¥æ”¯æŒå¯é‡å…¥ï¼Œæ˜¯å› ä¸º Java çš„å¯¹è±¡å¤´åŒ…å«äº†ä¸€ä¸ª Mark Wordï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬é”ä¿¡æ¯ã€‚

- å½“ä¸€ä¸ªçº¿ç¨‹è·å–å¯¹è±¡é”æ—¶ï¼ŒJVM ä¼šå°†è¯¥çº¿ç¨‹çš„ ID å†™å…¥ Mark Wordï¼Œå¹¶å°†é”è®¡æ•°å™¨è®¾ä¸º 1ã€‚

  å¦‚æœä¸€ä¸ªçº¿ç¨‹å°è¯•å†æ¬¡è·å–å·²ç»æŒæœ‰çš„é”ï¼ŒJVM ä¼šæ£€æŸ¥ Mark Word ä¸­çš„çº¿ç¨‹ IDã€‚å¦‚æœ ID åŒ¹é…ï¼Œè¡¨ç¤ºçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé”è®¡æ•°å™¨é€’å¢ã€‚

  å½“çº¿ç¨‹é€€å‡ºåŒæ­¥å—æ—¶ï¼Œé”è®¡æ•°å™¨é€’å‡ã€‚å¦‚æœè®¡æ•°å™¨å€¼ä¸ºé›¶ï¼ŒJVM å°†é”æ ‡è®°ä¸ºæœªæŒæœ‰çŠ¶æ€ï¼Œå¹¶æ¸…é™¤çº¿ç¨‹ ID ä¿¡æ¯ã€‚

  

## Synchronizedä¼˜åŒ–åŸç†

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šMark Wordå˜åŒ–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-34.png)

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé”å‡çº§ç®€ç•¥è¿‡ç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-36.png)

### 1. è½»é‡çº§é”

### 2. é”è†¨èƒ€

![image-20250126232145374](https://github.com/user-attachments/assets/4b71e771-e9b5-4d13-81f9-9794447ffa6b)

![image-20250126232331090](https://github.com/user-attachments/assets/7f690957-4562-4041-9f95-1bc05d9e41f8)


### 3. è‡ªæ—‹ä¼˜åŒ–

å½“çº¿ç¨‹å°è¯•è·å–è½»é‡çº§é”å¤±è´¥æ—¶ï¼Œå®ƒä¼šè¿›è¡Œè‡ªæ—‹ï¼Œå³å¾ªç¯æ£€æŸ¥é”æ˜¯å¦å¯ç”¨ï¼Œä»¥é¿å…ç«‹å³è¿›å…¥é˜»å¡çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³æŒé”çº¿ç¨‹å·²ç»é€€å‡ºåŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚

![image-20250126233420970](https://github.com/user-attachments/assets/d6ec6358-1bc1-418a-a205-8675dc0f6a1a)

![image-20250126233439471](https://github.com/user-attachments/assets/07464428-0a50-46d1-8b2d-ba8f67fcf957)


### 4. åå‘é”
![image-20250127134217619](https://github.com/user-attachments/assets/87c0052d-a8a1-402a-a4b0-01f203cea2f1)


**åå‘é”æ’¤é”€**

- åœ¨åå‘é”çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨`hashCode()`æ–¹æ³•ä¼šä¼šæ’¤é”€åå‘é”ï¼Œæ”¹ä¸ºè½»é‡çº§é”
- å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”

- è°ƒç”¨wait / notifyï¼Œä¾èµ–é‡é‡çº§é”monitorä¸­çš„Wait Set

  

ï¼ˆ å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–è¿™ä¸ªå·²è¢«åå‘çš„é”ï¼ŒJVM ä¼šæ£€æŸ¥å½“å‰æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»è·ƒã€‚å¦‚æœæŒæœ‰åå‘é”çš„çº¿ç¨‹ä¸æ´»è·ƒï¼Œåˆ™å¯ä»¥å°†é”é‡åå‘è‡³æ–°çš„çº¿ç¨‹ï¼›å¦‚æœæŒæœ‰åå‘é”çš„çº¿ç¨‹è¿˜æ´»è·ƒï¼Œåˆ™éœ€è¦æ’¤é”€åå‘é”ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚ï¼‰

**æ‰¹é‡é‡åå‘**

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20æ¬¡åï¼ŒJVMä¼šè®¤ä¸ºè‡ªå·±åå‘é”™äº†ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹

**æ‰¹é‡æ’¤é”€**

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡40æ¬¡æ—¶ï¼ŒJVMä¼šè®¤ä¸ºä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜æˆä¸å¯åå‘çš„ã€‚

### 5. é”æ¶ˆé™¤

å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ç”¨åˆ°é”ï¼ŒJITå³æ—¶ç¼–è¯‘ä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå»æ‰é”ã€‚

### 6. é”ç²—åŒ–

å¦‚æœ JVM æ£€æµ‹åˆ°ä¸€ç³»åˆ—è¿ç»­çš„é”æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å•ä¸€çº¿ç¨‹ä¸­å®Œæˆçš„ï¼Œåˆ™ä¼šå°†å¤šä¸ªé”æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§èŒƒå›´çš„é”æ“ä½œï¼Œè¿™å¯ä»¥å‡å°‘é”è¯·æ±‚çš„æ¬¡æ•°ã€‚



## è½»é‡çº§é”åŠ é”æµç¨‹

### T1 å°è¯•åŠ é”ï¼ˆç¬¬ä¸€æ¬¡è¿›å…¥åŒæ­¥å—ï¼‰

1. JVM åœ¨ `T1` çš„ **æ ˆå¸§ä¸­åˆ›å»º Lock Recordï¼ˆé”è®°å½•ï¼‰**
2. æŠŠå¯¹è±¡å¤´ä¸­çš„ **Mark Word æ‹·è´åˆ° Lock Record ä¸­**
3. **å°è¯•ç”¨ CAS** å°†å¯¹è±¡çš„ Mark Word æ›¿æ¢ä¸º **æŒ‡å‘ Lock Record çš„æŒ‡é’ˆ**
4. å¦‚æœ CAS æˆåŠŸ â†’ åŠ é”æˆåŠŸï¼ˆT1 è·å¾—é”ï¼Œå¯¹è±¡å¤„äºè½»é‡çº§é”çŠ¶æ€ï¼‰
5. å¦‚æœ CAS å¤±è´¥ â†’ è¡¨ç¤ºæœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼ˆè§ä¸‹ï¼‰

###  T2 ä¹Ÿå°è¯•åŠ é”ï¼ˆäº§ç”Ÿç«äº‰ï¼‰

- T2 æ£€æµ‹åˆ°å¯¹è±¡å¤´çš„ Mark Word ä¸å†æ˜¯æ— é”çŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯åå‘è‡ªå·±
- CAS å¤±è´¥ â†’ è¿›å…¥â€œ**è‡ªæ—‹**â€é˜¶æ®µå°è¯•ç­‰å¾… T1 é‡Šæ”¾é”
- å¦‚æœè‡ªæ—‹å¤±è´¥ï¼ˆä¾‹å¦‚å°è¯•æ¬¡æ•°å¤ªå¤šï¼‰ â†’ é”å‡çº§ä¸º**é‡é‡çº§é”**



## ReentrantLockæ˜¯ä»€ä¹ˆ

**å¯ä¸­æ–­**ï¼ˆSynchronizedä¸è¡Œï¼‰

	`lock.lockInterruptibly()`
	
	å¦‚æœæ²¡æœ‰ç«äº‰æ­¤æ–¹æ³•å°±è·å–lockå¯¹è±¡é”
	
	å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶å®ƒçº¿ç¨‹ç”¨interruptæ–¹æ³•æ‰“æ–­

**å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´**ï¼ˆSynchronizedä¸è¡Œï¼‰

	`lock.tryLock(1, TimeUnit.SECONDS)`
	
	è¿”å›å€¼æ˜¯booleanç±»å‹ï¼Œè·å–é”æˆåŠŸä¸ºtrue

**å¯ä»¥è®¾ç½®å…¬å¹³é”**ï¼ˆSynchronizedä¸è¡Œï¼‰

**æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡**ï¼ˆSynchronizedä¸è¡Œï¼‰

	Condition A = ReentrantLock.newCondition();
	
	// awaitå’Œsignalå¿…é¡»åœ¨åŒæ­¥å—å†…æ‰§è¡Œ
	A.await();
	
	A.signal();

**ä¸synchronizedä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥**



## ReentrantLockå’ŒSynchronizedçš„åŒºåˆ«

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsynchronizedå’ŒReentrantLockçš„åŒºåˆ«](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-38.png)



## AQSäº†è§£å¤šå°‘

**AQS(Abstract Queue Synchronizer)**çš„æ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å½“å‰çº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–èµ„æºï¼›å¦åˆ™ï¼Œå®ƒå°†è¿›å…¥ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼Œç³»ç»Ÿä¼šæŒ‘é€‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œèµ‹äºˆå…¶èµ„æºã€‚



![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šAQSæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-39.png)

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šReentrantLock éå…¬å¹³é”åŠ é”æµç¨‹ç®€å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-42.png)

## CASäº†è§£å¤šå°‘

CASæ˜¯ä¸€ç§ä¹è§‚é”çš„å®ç°æ–¹å¼ï¼Œå…¨ç§°ä¸ºCompare and Swapï¼Œæ˜¯ä¸€ç§æ— é”çš„åŸå­æ“ä½œã€‚

CAS æ˜¯ä¹è§‚é”ï¼Œçº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ä¸ä¼šåŠ é”ï¼Œå®ƒä¼šå‡è®¾æ­¤æ—¶æ²¡æœ‰å†²çªï¼Œç„¶åå®ŒæˆæŸé¡¹æ“ä½œï¼›å¦‚æœå› ä¸ºå†²çªå¤±è´¥äº†å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚



## CASæ€ä¹ˆä¿è¯æ•°æ®åŸå­æ€§

ä¸ºäº†ä¿è¯CASçš„åŸå­æ€§ï¼ŒCPU æä¾›äº†ä¸¤ç§å®ç°æ–¹å¼

**1. æ€»çº¿é”å®š**

- é€šè¿‡é”å®š CPU çš„æ€»çº¿ï¼Œç¦æ­¢å…¶ä»– CPU æˆ–è®¾å¤‡è®¿é—®å†…å­˜ã€‚

**2. ç¼“å­˜é”å®šï¼ˆä¼˜å…ˆï¼‰**

- å½“å¤šä¸ª CPU æ“ä½œåŒä¸€å—å†…å­˜åœ°å€æ—¶ï¼Œå¦‚æœè¯¥å†…å­˜åœ°å€å·²ç»è¢«ç¼“å­˜åˆ°æŸä¸ª CPU çš„ç¼“å­˜ä¸­ï¼Œç¼“å­˜é”å®šæœºåˆ¶ä¼šé”å®šè¯¥ç¼“å­˜è¡Œï¼Œé˜²æ­¢å…¶ä»– CPU å¯¹è¿™å—å†…å­˜è¿›è¡Œä¿®æ”¹ã€‚
- MESIåè®®



## CASæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šCASä¸‰å¤§é—®é¢˜](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-44.png)

**ABAé—®é¢˜**

å¦‚æœä¸€ä¸ªä½ç½®çš„å€¼åŸæ¥æ˜¯ Aï¼Œåæ¥è¢«æ”¹ä¸º Bï¼Œå†åæ¥åˆè¢«æ”¹å› Aï¼Œé‚£ä¹ˆè¿›è¡Œ CAS æ“ä½œçš„çº¿ç¨‹å°†æ— æ³•çŸ¥æ™“è¯¥ä½ç½®çš„å€¼åœ¨æ­¤æœŸé—´å·²ç»è¢«ä¿®æ”¹è¿‡ã€‚

å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·/æ—¶é—´æˆ³çš„æ–¹å¼æ¥è§£å†³ ABA é—®é¢˜ã€‚

æ¯”å¦‚è¯´ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°æ—¶ï¼Œä¸ä»…æ›´æ–°å˜é‡çš„å€¼ï¼Œè¿˜æ›´æ–°ä¸€ä¸ªç‰ˆæœ¬å·ã€‚CAS æ“ä½œæ—¶ä¸ä»…è¦æ±‚å€¼åŒ¹é…ï¼Œè¿˜è¦æ±‚ç‰ˆæœ¬å·åŒ¹é…ã€‚



**å¾ªç¯æ€§èƒ½å¼€é”€**

è‡ªæ—‹ CASï¼Œå¦‚æœä¸€ç›´å¾ªç¯æ‰§è¡Œï¼Œä¸€ç›´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚

> æ€ä¹ˆè§£å†³å¾ªç¯æ€§èƒ½å¼€é”€é—®é¢˜ï¼Ÿ

åœ¨ Java ä¸­ï¼Œå¾ˆå¤šä½¿ç”¨è‡ªæ—‹ CAS çš„åœ°æ–¹ï¼Œä¼šæœ‰ä¸€ä¸ªè‡ªæ—‹æ¬¡æ•°çš„é™åˆ¶ï¼Œè¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œå°±åœæ­¢è‡ªæ—‹ã€‚



**åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ“ä½œ**

CAS ä¿è¯çš„æ˜¯å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œæ“ä½œçš„åŸå­æ€§ï¼Œå¦‚æœå¯¹å¤šä¸ªå˜é‡æ“ä½œæ—¶ï¼ŒCAS ç›®å‰æ— æ³•ç›´æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§çš„ã€‚

```java
class Account {
    AtomicInteger balance1 = new AtomicInteger(100);
    AtomicInteger balance2 = new AtomicInteger(200);

    void transfer(int amount) {
        // ğŸš¨ ä¸æ˜¯åŸå­æ“ä½œï¼ä¸¤ä¸ª CAS ä¹‹é—´å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­
        balance1.getAndAdd(-amount);  // ä»è´¦æˆ· 1 æ‰£é’±
        
        //åœ¨ä¸¤ä¸ªå˜é‡çš„CASä¹‹é—´å¦ä¸€ä¸ªçº¿ç¨‹è¯»ï¼Œæ­¤æ—¶è´¦æˆ·1æ‰£çš„é’±è¿˜æ²¡åŠ åˆ°è´¦æˆ·2ä¸­ 
        
        balance2.getAndAdd(amount);   // å‘è´¦æˆ· 2 åŠ é’±
    }
}

```



> æ€ä¹ˆè§£å†³åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ“ä½œé—®é¢˜ï¼Ÿ

- å¯ä»¥è€ƒè™‘æ”¹ç”¨é”æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§
- å¯ä»¥è€ƒè™‘åˆå¹¶å¤šä¸ªå˜é‡ï¼Œå°†å¤šä¸ªå˜é‡å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡ AtomicReference æ¥ä¿è¯åŸå­æ€§ã€‚



## åŸå­æ“ä½œç±»æœ‰å“ªäº›

![åŸå­æ“ä½œç±»](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-46.png)

## åŸå­æ“ä½œç±»çš„åŸç†

**ä½¿ç”¨CASå®ç°**

ä»¥ AtomicInteger çš„æ·»åŠ æ–¹æ³•ä¸ºä¾‹ï¼š

```java
    public final int getAndIncrement() {
        return unsafe.getAndAddInt(this, valueOffset, 1);
    }
```

```java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

    return var5;
}
```

å¦‚æœ `var1` çš„ `var2` åç§»åœ°å€å¤„çš„å€¼ **ä»ç„¶ç­‰äº `var5`**ï¼š

- âœ… **æ›´æ–°ä¸º `var5 + var4`**ï¼ˆåŠ  `var4`ï¼‰ã€‚

å¦åˆ™ï¼š

- âŒ **æ›´æ–°å¤±è´¥ï¼ˆè¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†è¯¥å€¼ï¼‰ï¼Œé‡æ–°è¯»å–å¹¶é‡è¯•**ã€‚



## æ­»é”äº§ç”Ÿçš„æ¡ä»¶

æ­»é”äº§ç”Ÿå››æ¡ä»¶

**1. äº’æ–¥æ¡ä»¶**ï¼šçº¿ç¨‹ä¸èƒ½è¢«å¤šçš„çº¿ç¨‹å…±äº«

**2. æŒæœ‰å¹¶ç­‰å¾…æ¡ä»¶**ï¼šä¸€ä¸ªçº¿ç¨‹è‡³å°‘å·²ç»æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œä¸”æ­£åœ¨ç­‰å¾…é¢å¤–çš„èµ„æº

**3. ä¸å¯å‰¥å¤ºæ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»ä¸€ä¸ªçº¿ç¨‹ä¸­æŠ¢å è¿‡æ¥

**4. å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šç­‰å¾…å…³ç³»ä¸­äº§ç”Ÿç¯è·¯



## å¦‚ä½•é¿å…æ­»é”

è‡³å°‘ç ´åæ­»é”äº§ç”Ÿçš„ä¸€ä¸ªæ¡ä»¶



## æ­»é”é—®é¢˜æ€ä¹ˆæ’æŸ¥

- é¦–å…ˆä»ç³»ç»Ÿçº§åˆ«ä¸Šæ’æŸ¥ï¼Œæ¯”å¦‚è¯´åœ¨ Linux ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥å…ˆä½¿ç”¨ top ps ç­‰å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰è¿›ç¨‹å ç”¨äº†è¿‡å¤šçš„èµ„æºã€‚
- æ¥ç€ä½¿ç”¨ JDK è‡ªå¸¦çš„ä¸€äº›æ€§èƒ½ç›‘æ§å·¥å…·è¿›è¡Œæ’æŸ¥ï¼Œæ¯”å¦‚è¯´ï¼Œä½¿ç”¨ `jps -l` æŸ¥çœ‹å½“å‰ Java è¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ `jstack è¿›ç¨‹å·` æŸ¥çœ‹å½“å‰ Java è¿›ç¨‹çš„çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…é”èµ„æºã€‚



## ä»€ä¹ˆæ˜¯çº¿ç¨‹åŒæ­¥

| **å¯¹æ¯”é¡¹**                         | **çº¿ç¨‹åŒæ­¥ï¼ˆSynchronizationï¼‰**       | **äº’æ–¥ï¼ˆMutexï¼‰**                  |
| ---------------------------------- | ------------------------------------- | ---------------------------------- |
| **ä½œç”¨**                           | ä¿è¯çº¿ç¨‹ä¹‹é—´æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ            | ç¡®ä¿å¤šä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æº   |
| **å¤šä¸ªçº¿ç¨‹èƒ½å¦åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Ÿ** | å¯èƒ½å¯ä»¥ï¼ˆå¦‚è¯»æ“ä½œï¼‰                  | ä¸èƒ½ï¼ˆåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼‰ |
| **å…³æ³¨ç‚¹**                         | çº¿ç¨‹æ‰§è¡Œçš„**æ—¶åºé—®é¢˜**                | çº¿ç¨‹æ‰§è¡Œçš„**ç‹¬å æ€§é—®é¢˜**           |
| **å¸¸è§å®ç°**                       | `wait() / notify()`ã€`CountDownLatch` | `synchronized`ã€`Lock`             |
| **åº”ç”¨åœºæ™¯**                       | ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼                     | å¤šçº¿ç¨‹è®¡æ•°å™¨ã€é“¶è¡Œè´¦æˆ·æ“ä½œ         |

**äº’æ–¥æ˜¯çº¿ç¨‹åŒæ­¥çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µ**ï¼Œæ‰€æœ‰**äº’æ–¥éƒ½æ˜¯åŒæ­¥**ï¼Œä½†**å¹¶ä¸æ˜¯æ‰€æœ‰åŒæ­¥éƒ½æ˜¯äº’æ–¥**ã€‚



## çº¿ç¨‹åŒæ­¥çš„å®ç°æ–¹å¼æœ‰å“ªäº›

- äº’æ–¥é‡
- è¯»å†™é”
- æ¡ä»¶å˜é‡
- è‡ªæ—‹é”
- å±éšœ
- ä¿¡å·é‡



## æ‚²è§‚é”å’Œä¹è§‚é”

- ä¹è§‚é”å¤šç”¨äºâ€œè¯»å¤šå†™å°‘â€œçš„ç¯å¢ƒï¼Œé¿å…é¢‘ç¹åŠ é”å½±å“æ€§èƒ½ï¼›
  - åœ¨è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œä¸åŒçš„çº¿ç¨‹å¯ä»¥å¹¶è¡Œè®¿é—®å…±äº«çš„èµ„æºï¼Œæé«˜æ€§èƒ½
  - åœ¨å†™å¤šçš„åœºæ™¯ä¸‹ï¼Œå¤§é‡çº¿ç¨‹å¤±è´¥ï¼Œè¿›å…¥è‡ªæ—‹ï¼Œå¤§é‡å ç”¨CPUèµ„æº
- æ‚²è§‚é”å¤šç”¨äºâ€å†™å¤šè¯»å°‘â€œçš„ç¯å¢ƒï¼Œé¿å…é¢‘ç¹å¤±è´¥å’Œé‡è¯•å½±å“æ€§èƒ½ã€‚



# ThreadLocal

## ThreadLocalæ€ä¹ˆå®ç°çš„

ThreadLocal çš„å®ç°åŸç†å°±æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ª ThreadLocalMapï¼Œkey ä¸º ThreadLocal å¯¹è±¡ï¼Œvalue ä¸ºæƒ³è¦å®ç°çº¿ç¨‹éš”ç¦»çš„å¯¹è±¡ã€‚

1ã€å½“éœ€è¦å­˜çº¿ç¨‹éš”ç¦»çš„å¯¹è±¡æ—¶ï¼Œé€šè¿‡ ThreadLocal çš„ set æ–¹æ³•å°†å¯¹è±¡å­˜å…¥ Map ä¸­ã€‚

2ã€å½“éœ€è¦å–çº¿ç¨‹éš”ç¦»çš„å¯¹è±¡æ—¶ï¼Œé€šè¿‡ ThreadLocal çš„ get æ–¹æ³•ä» Map ä¸­å–å‡ºå¯¹è±¡ã€‚

3ã€Map çš„å¤§å°ç”± ThreadLocal å¯¹è±¡çš„å¤šå°‘å†³å®šã€‚

![ThreadLocal çš„ç»“æ„](https://cdn.tobebetterjavaer.com/stutymore/javathread-20240407205747.png)

## ThreadLocalå†…å­˜æ³„éœ²æ˜¯æ€ä¹ˆå›äº‹

**ä»€ä¹ˆæ˜¯å¼±å¼•ç”¨ï¼Œä»€ä¹ˆæ˜¯å¼ºå¼•ç”¨**

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šThreadLocalå†…å­˜åˆ†é…](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-14.png)

å¦‚æœæŸä¸ª ThreadLocal å˜é‡åœ¨ä»£ç ä¸­ä¸å†æœ‰å¼ºå¼•ç”¨ï¼ˆä¾‹å¦‚ threadLocal = null;ï¼‰ï¼Œå¹¶ä¸”å®ƒçš„ key æ˜¯ **å¼±å¼•ç”¨**ï¼ˆåœ¨ ThreadLocalMap ä¸­ï¼‰ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶ï¼ŒThreadLocal å®ä¾‹å°±ä¼šè¢«å›æ”¶ã€‚

åœ¨ ThreadLocal è¢«åƒåœ¾æ”¶é›†åï¼Œä¸‹ä¸€æ¬¡è®¿é—® ThreadLocalMap æ—¶ï¼ŒJava ä¼šè‡ªåŠ¨æ¸…ç†é‚£äº›é”®ä¸º null çš„æ¡ç›®ï¼ˆå‚ç…§æºç ä¸­çš„ replaceStaleEntry æ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨æ‰§è¡Œ ThreadLocalMap ç›¸å…³æ“ä½œï¼ˆå¦‚ `get()`, `set()`, `remove()`ï¼‰æ—¶è§¦å‘ã€‚



**å†…å­˜æ³„éœ²**

é€šå¸¸æƒ…å†µä¸‹ï¼Œéšç€çº¿ç¨‹ Thread çš„ç»“æŸï¼Œå…¶å†…éƒ¨çš„ ThreadLocalMap ä¹Ÿä¼šè¢«å›æ”¶ï¼Œä»è€Œé¿å…äº†å†…å­˜æ³„æ¼ã€‚

ä½†å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸€ç›´åœ¨è¿è¡Œï¼Œå¹¶ä¸”å…¶ ThreadLocalMap ä¸­çš„ Entry.value ä¸€ç›´æŒ‡å‘æŸä¸ªå¼ºå¼•ç”¨å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å½“ Entry éå¸¸å¤šæ—¶ï¼Œå¯èƒ½å°±ä¼šå¼•å‘æ›´ä¸¥é‡çš„å†…å­˜æº¢å‡ºé—®é¢˜ã€‚



## ThreadLocalMapçš„æºç çœ‹è¿‡å—

**1. å…ƒç´ æ•°ç»„**

ä¸€ä¸ª table æ•°ç»„ï¼Œå­˜å‚¨ Entry ç±»å‹çš„å…ƒç´ ï¼ŒEntry æ˜¯ ThreaLocal å¼±å¼•ç”¨ä½œä¸º keyï¼ŒObject ä½œä¸º value çš„ç»“æ„ã€‚

```java
private Entry[] table;
```



**2. æ•£åˆ—æ–¹æ³•**

æ•£åˆ—æ–¹æ³•å°±æ˜¯æ€ä¹ˆæŠŠå¯¹åº”çš„ key æ˜ å°„åˆ° table æ•°ç»„çš„ç›¸åº”ä¸‹æ ‡ï¼ŒThreadLocalMap ç”¨çš„æ˜¯å“ˆå¸Œå–ä½™æ³•ï¼Œå–å‡º key çš„ threadLocalHashCodeï¼Œç„¶åå’Œ table æ•°ç»„é•¿åº¦å‡ä¸€&è¿ç®—ï¼ˆç›¸å½“äºå–ä½™ï¼‰ã€‚

```java
int i = key.threadLocalHashCode & (table.length - 1);
```

æ¯åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼Œå®ƒå°±ä¼šæ–°å¢`0x61c88647`ï¼Œè¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œå®ƒæ˜¯**æ–æ³¢é‚£å¥‘æ•°** ä¹Ÿå« **é»„é‡‘åˆ†å‰²æ•°**ã€‚`hash`å¢é‡ä¸º è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ `hash` **åˆ†å¸ƒéå¸¸å‡åŒ€**ã€‚

```java
private static final int HASH_INCREMENT = 0x61c88647;

private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}
```



## çˆ¶å­çº¿ç¨‹æ€ä¹ˆå…±äº«æ•°æ®

çˆ¶çº¿ç¨‹èƒ½ç”¨ ThreadLocal æ¥ç»™å­çº¿ç¨‹ä¼ å€¼å—ï¼Ÿ**ä¸èƒ½ã€‚**



# å†…å­˜æ¨¡å‹

## ä¸ºä»€ä¹ˆçº¿ç¨‹è¦ç”¨è‡ªå·±çš„å†…å­˜

![æ·±å…¥æµ…å‡º Java å¤šçº¿ç¨‹ï¼šJavaå†…å­˜æ¨¡å‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/jmm-f02219aa-e762-4df0-ac08-6f4cceb535c2.jpg)

- çº¿ç¨‹éœ€è¦è‡ªå·±çš„æ ˆæ¥å­˜å‚¨å±€éƒ¨å˜é‡ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼Œä¸åŒçº¿ç¨‹è°ƒç”¨åŒä¸€æ–¹æ³•æ—¶ï¼Œå±€éƒ¨å˜é‡ä¸èƒ½äº’ç›¸å¹²æ‰°ï¼‰
- å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡ï¼Œä¼šå¼•å‘æ›´å¤šçš„å†…å­˜è®¿é—®ç«äº‰ï¼Œè¿™ä¸ä»…å½±å“æ€§èƒ½ï¼Œè¿˜å¢åŠ äº†çº¿ç¨‹å®‰å…¨é—®é¢˜çš„å¤æ‚åº¦ã€‚
- ç°ä»£ CPU ä¸ºäº†ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œä¹±åºæ‰§è¡Œï¼ˆæŒ‡ä»¤é‡æ’åºï¼‰ã€‚ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼ˆCPU ç¼“å­˜å’Œå¯„å­˜å™¨ï¼‰å¯ä»¥åœ¨ä¸å½±å“æœ€ç»ˆæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œä½¿å¾— CPU æœ‰æ›´å¤§çš„è‡ªç”±åº¦æ¥ä¹±åºæ‰§è¡ŒæŒ‡ä»¤ï¼Œä»è€Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚



## finalå˜é‡å¦‚ä½•ä¿è¯å¯è§æ€§

Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰è§„å®šï¼š

- **æ™®é€šå˜é‡** åœ¨æ„é€ å¯¹è±¡æ—¶ï¼Œå¯èƒ½**å…ˆå‘å¸ƒï¼ˆå¯¹è±¡å¯è§ï¼‰ï¼Œåèµ‹å€¼**ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹çœ‹åˆ°çš„æ˜¯**æœªåˆå§‹åŒ–**çš„å€¼ï¼ˆå³é‡æ’åºé—®é¢˜ï¼‰ã€‚

- **`final` å˜é‡** ç”±äº JMM è§„åˆ™ï¼Œ**æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œ`final` å˜é‡çš„å€¼å¿…é¡»å¯¹å…¶ä»–çº¿ç¨‹å¯è§**ï¼Œé¿å…äº†é‡æ’åºå¯¼è‡´çš„æœªåˆå§‹åŒ–é—®é¢˜ã€‚



ä¹Ÿæ˜¯é€šè¿‡è¯»å†™å±éšœå®ç°çš„ã€‚**å†™å…¥ `final` å˜é‡çš„æ“ä½œ** å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹ **Happens-Before** å˜é‡çš„è¯»æ“ä½œã€‚



## ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’

**1. ç¼–è¯‘å™¨ä¼˜åŒ–**

- ç¼–è¯‘å™¨ä¼šè°ƒæ•´æŒ‡ä»¤é¡ºåºï¼Œä»¥æé«˜æŒ‡ä»¤æµæ°´çº¿æ•ˆç‡ã€‚

**2. CPU æŒ‡ä»¤ä¹±åºæ‰§è¡Œ**

- CPU å¯èƒ½ä¼šè°ƒæ•´æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œä»¥æé«˜æŒ‡ä»¤å¹¶è¡Œåº¦ã€‚

**3. å†…å­˜ç³»ç»Ÿçš„é‡æ’åº**

- å¤„ç†å™¨ä¼šä½¿ç”¨**ç¼“å­˜**å’Œ**å†™ç¼“å†²åŒº**ï¼Œå¯¼è‡´å†…å­˜è®¿é—®é¡ºåºå¯èƒ½ä¸ä»£ç æ‰§è¡Œé¡ºåºä¸åŒã€‚



## æŒ‡ä»¤é‡æ’æœ‰é™åˆ¶å—ï¼Ÿhappens-beforeäº†è§£å—ï¼Ÿ

æŒ‡ä»¤é‡æ’ä¹Ÿæ˜¯æœ‰ä¸€äº›é™åˆ¶çš„ï¼Œæœ‰ä¸¤ä¸ªè§„åˆ™**happens-before**å’Œ**as-if-serial**æ¥çº¦æŸã€‚

- å¦‚æœä¸€ä¸ªæ“ä½œ happens-before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
- ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€ Java å¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§ happens-before å…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰ happens-before å…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•



![happens-beforeå…­å¤§è§„åˆ™](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-23.png)

- **ç¨‹åºé¡ºåºè§„åˆ™**ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-before äºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚
- **ç›‘è§†å™¨é”è§„åˆ™**ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-before äºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚
- **volatile å˜é‡è§„åˆ™**ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚
- **ä¼ é€’æ€§**ï¼šå¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before Cã€‚
- **start()è§„åˆ™**ï¼šå¦‚æœçº¿ç¨‹ A æ‰§è¡Œæ“ä½œ ThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹ Bï¼‰ï¼Œé‚£ä¹ˆ A çº¿ç¨‹çš„ ThreadB.start()æ“ä½œ happens-before äºçº¿ç¨‹ B ä¸­çš„ä»»æ„æ“ä½œã€‚
- **join()è§„åˆ™**ï¼šå¦‚æœçº¿ç¨‹ A æ‰§è¡Œæ“ä½œ ThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹ B ä¸­çš„ä»»æ„æ“ä½œ happens-before äºçº¿ç¨‹ A ä» ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚



## as-if-serialåˆæ˜¯ä»€ä¹ˆï¼Ÿå•çº¿ç¨‹çš„ç¨‹åºä¸€å®šæ˜¯é¡ºåºçš„å—

as-if-serial è¯­ä¹‰çš„æ„æ€æ˜¯ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œ**å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜**ã€‚



## volatileåŸç†

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼švolatileå†™æ’å…¥å†…å­˜å±éšœåç”Ÿæˆçš„æŒ‡ä»¤åºåˆ—ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-28.png)

**1. å¦‚ä½•ä¿è¯å¯è§æ€§**

- å¯¹volatileå˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥**å†™å±éšœ**
  - å†™å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹å‰ï¼Œå¯¹æ‰€æœ‰å˜é‡çš„æ”¹åŠ¨éƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­
- å¯¹volatileå˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥**è¯»å±éšœ**
  - è¯»å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–åŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®



**2. å¦‚ä½•ä¿è¯æœ‰åºæ€§**

- å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å
- è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰



**3. ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™**

![image-20250128213711292](https://github.com/user-attachments/assets/21d90c48-51be-4861-b0d3-3ff428950355)

```java
private volatile SomeObject obj = new SomeObject();
```

â€‹	è™½ç„¶ volatileç¡®ä¿äº† obj å¼•ç”¨çš„å¯è§æ€§ï¼Œä½†å¯¹ objå¼•ç”¨çš„å…·ä½“å¯¹è±¡çš„æ“ä½œå¹¶ä¸å— volatileä¿æŠ¤ã€‚å¦‚æœéœ€è¦ä¿è¯å¼•ç”¨å¯¹è±¡å†…éƒ¨çŠ¶æ€çš„çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ synchronizedæˆ– ReentrantLockï¼‰ã€‚



**æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼**

```java
public final class Singleton {
    private Singleton(){}
    private static Singleton INSTANCE = null;
    
    public static Singleton getInstance() {
        if(INSTANCE == null){
            synchronized (Singleton.class){
                if(INSTANCE == null){
                    INSTANCE = new Singleton();
                }
            }
        }
        return INSTANCE;
    }
}
```

è¿™æ®µä»£ç æ˜¯**ä¸æ­£ç¡®**çš„ï¼Œå› ä¸ºINSTANCEå˜é‡å¹¶æ²¡æœ‰å®Œå…¨è¢«synchronizedä»£ç å—åŒ…å›´ä½ã€‚ä¸”synchronizedå†…éƒ¨æ˜¯æœ‰å¯èƒ½å‘ç”ŸæŒ‡ä»¤é‡æ’åºçš„ï¼Œå³å…ˆç»™INSTANCEèµ‹å€¼ï¼Œå†è°ƒç”¨`new Singletion()`æ–¹æ³•åˆå§‹åŒ–ï¼Œè¿™æ—¶æœ‰ç¬¬äºŒä¸ªçº¿ç¨‹åœ¨INSTANCEåˆå§‹åŒ–ä¹‹å‰å°±è¿”å›äº†INSTANCEã€‚



```java
public final class Singleton {
    private Singleton(){}
    private static volatile Singleton INSTANCE = null;
    
    public static Singleton getInstance() {
        if(INSTANCE == null){
            synchronized (Singleton.class){
                if(INSTANCE == null){
                    INSTANCE = new Singleton();
                }
            }
        }
        return INSTANCE;
    }
}

```

åœ¨INSTANCEå˜é‡ä¸ŠåŠ ä¸Švolatileé˜²æ­¢é‡æ’åºï¼Œé€šè¿‡å†™å±éšœä¿è¯åˆå§‹åŒ–åœ¨èµ‹å€¼ä¹‹å‰æ‰§è¡Œã€‚



# çº¿ç¨‹æ± 

## çº¿ç¨‹æ± çŠ¶æ€æœ‰å“ªäº›

ThreadPoolExecutorä½¿ç”¨intçš„é«˜3ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡

![image-20250129105817900](https://github.com/user-attachments/assets/34d583d7-0734-44de-86ee-4a79b75201c0)

![çº¿ç¨‹æ± çŠ¶æ€åˆ‡æ¢å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-78.png)

å¯ä»¥é€šè¿‡åå°„è·å–çº¿ç¨‹æ± çŠ¶æ€

```java
   // é€šè¿‡åå°„è·å–çº¿ç¨‹æ± çŠ¶æ€
    private static String getState(ThreadPoolExecutor executor) {
        try {
            java.lang.reflect.Field field = ThreadPoolExecutor.class.getDeclaredField("ctl");
            field.setAccessible(true);
            int ctl = (Integer) field.get(executor);
            int state = ctl >>> 29;
            switch (state) {
                case 0: return "RUNNING";
                case 1: return "SHUTDOWN";
                case 2: return "STOP";
                case 3: return "TIDYING";
                case 4: return "TERMINATED";
                default: return "UNKNOWN";
            }
        } catch (Exception e) {
            return "æ— æ³•è·å–";
        }
    }
```



## çº¿ç¨‹æ± å‚æ•°æœ‰å“ªäº›

**corePoolSize**ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°

**maximumPoolSize**: æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ•‘æ€¥çº¿ç¨‹ = maximumPoolSize - corePoolSizeï¼Œå½“æ ¸å¿ƒçº¿ç¨‹å’Œé˜»å¡é˜Ÿåˆ—éƒ½æ»¡äº†çš„æ—¶å€™ï¼Œä¸‹ä¸€ä¸ªæ¥çš„ä»»åŠ¡äº¤ç»™**æ•‘æ€¥çº¿ç¨‹**è¿è¡Œï¼Œæ•‘æ€¥çº¿ç¨‹æ‰§è¡Œå®Œäº†å°±ä¼šé”€æ¯ï¼Œä¸ä¼šåƒæ ¸å¿ƒçº¿ç¨‹ä¸€æ ·ä¿ç•™ï¼‰

**keepAliveTime**ï¼šç”Ÿå­˜æ—¶é—´ â€” é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹

**unit**ï¼šæ—¶é—´å•ä½

**workQueue**ï¼šé˜»å¡é˜Ÿåˆ—

**threadFactory**ï¼šçº¿ç¨‹å·¥å‚ â€” ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·åå­—

**handler**ï¼šæ‹’ç»ç­–ç•¥



## çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›

![image-20250129111236731](https://github.com/user-attachments/assets/e52ef73d-51d0-4978-b47e-d69cb0bdb97a)




## çº¿ç¨‹æ± ç±»å‹

**newFixedThreadPool**

![FixedThreadPool](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-73.png)

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
    return new ThreadPoolExecutor(
        nThreads, 
        nThreads, 
        0L, 
        TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>());
}
```

- æ ¸å¿ƒçº¿ç¨‹ = æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´
- é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„

é€‚åˆäºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡



**newCachedThreadPool**

![CachedThreadPoolæ‰§è¡Œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-74.png)

```java
public static ExecutorService newCachedThreadPool() {
    return new ThreadPoolExecutor(
        0, 
        Integer.MAX_VALUE, 
        60L, 
        TimeUnit.SECONDS, 
        new SynchronousQueue<Runnable>());
}
```

- æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯0ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯Integer.MAX_VALUEï¼Œç”Ÿå­˜æ—¶é—´æ˜¯60s

  - å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹

  - **æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º**

- é˜Ÿåˆ—é‡‡ç”¨äº†SynchronousQueueå®ç°ç‰¹ç‚¹æ˜¯ï¼Œæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„

é€‚åˆä»»åŠ¡æ•°å¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ



**newSingleThreadExecutor**

![SingleThreadExecutorè¿è¡Œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-72.png)

```java
public static ExecutorService newSingleThreadExecutor() {
    return new FinalizableDelegatedExecutorService(
    	new ThreadPoolExecutor(
            i, 
            1,
            0L,
            TimeUnit.MILLISECONDS,
            new LinkedBlockingQueue<Runnable>())
    );
}
```

- çº¿ç¨‹æ•°å›ºå®šä¸º1ä¸”å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹
- ä»»åŠ¡æ•°å¤šäº1æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿ
- è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œï¼ˆå§‹ç»ˆä¿è¯æœ‰ä¸€ä¸ªå¯ç”¨çš„çº¿ç¨‹ï¼‰



**newScheduledThreadPool**

![ScheduledThreadPoolæ‰§è¡Œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-75.png)

```java
public static ExecutorService newScheduledThreadExecutor() {
    return new ThreadPoolExecutor(
        corePoolsize,
        Integer.MAX_VALUE,
        0,
        TimeUnit.NANOSECONDS,
        new DelayedWorkQueue<Runnable>()
    );
}
```

- æœ€å¤§çº¿ç¨‹æ•°ä¸º Integer.MAX_VALUEï¼Œä¹Ÿæœ‰ OOM çš„é£é™©
- é˜»å¡é˜Ÿåˆ—æ˜¯ DelayedWorkQueue
- keepAliveTime ä¸º 0
- scheduleAtFixedRate() ï¼šæŒ‰æŸç§é€Ÿç‡å‘¨æœŸæ‰§è¡Œ
- scheduleWithFixedDelay()ï¼šåœ¨æŸä¸ªå»¶è¿Ÿåæ‰§è¡Œ



## çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›

- ArrayBlockingQueue

  - æœ‰ç•Œçš„å…ˆè¿›å…ˆå‡ºçš„é˜»å¡é˜Ÿåˆ—ï¼Œåº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€‚åˆå›ºå®šå¤§å°çš„çº¿ç¨‹æ± 

  ```java
  public class ArrayBlockingQueue<E> implements BlockingQueue<E> {
      final Object[] items;              // å­˜å‚¨å…ƒç´ çš„æ•°ç»„
      int takeIndex;                     // ä¸‹ä¸€æ¬¡ take çš„ç´¢å¼•
      int putIndex;                      // ä¸‹ä¸€æ¬¡ put çš„ç´¢å¼•
      int count;                         // å½“å‰å…ƒç´ æ•°é‡
  
      final ReentrantLock lock;          // ä¸€æŠŠç‹¬å é”
      final Condition notEmpty;          // é˜Ÿåˆ—ä¸ä¸ºç©ºæ¡ä»¶
      final Condition notFull;           // é˜Ÿåˆ—ä¸ä¸ºæ»¡æ¡ä»¶
  }
  ```

  ```java
  public void put(E e) throws InterruptedException {
      final ReentrantLock lock = this.lock;
      lock.lockInterruptibly();         // è·å–é”
      try {
          while (count == items.length)
              notFull.await();         // é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…
  
          enqueue(e);                  // å…¥é˜Ÿï¼Œæ›´æ–° putIndexã€count
          notEmpty.signal();           // é€šçŸ¥ç­‰å¾… take çš„çº¿ç¨‹
      } finally {
          lock.unlock();               // é‡Šæ”¾é”
      }
  }
  ```

  

- LinkedBlockingQueue

  - åº•å±‚æ•°æ®ç»“æ„æ˜¯é“¾è¡¨ï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤å¤§å°æ˜¯ Integer.MAX_VALUEï¼Œç›¸å½“äºä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚

  ```java
  public class LinkedBlockingQueue<E> implements BlockingQueue<E> {
      static class Node<E> {
          E item;
          Node<E> next;
      }
  
      final int capacity;                  // å®¹é‡é™åˆ¶
      final AtomicInteger count = new AtomicInteger(); // å½“å‰å…ƒç´ ä¸ªæ•°
  
      transient Node<E> head;
      transient Node<E> last;
  
      final ReentrantLock putLock = new ReentrantLock();
      final Condition notFull = putLock.newCondition();
  
      final ReentrantLock takeLock = new ReentrantLock();
      final Condition notEmpty = takeLock.newCondition();
  }
  ```

  ```java
  public void put(E e) throws InterruptedException {
      if (e == null) throw new NullPointerException();
      int c = -1;
      Node<E> node = new Node<>(e);
      final ReentrantLock putLock = this.putLock;
      final AtomicInteger count = this.count;
  
      putLock.lockInterruptibly();
      try {
          while (count.get() == capacity)
              notFull.await();             // ç­‰å¾…ç©ºä½
  
          enqueue(node);                   // é“¾è¡¨æ·»åŠ èŠ‚ç‚¹
          c = count.getAndIncrement();
          if (c + 1 < capacity)
              notFull.signal();            // å”¤é†’å…¶ä»– put
      } finally {
          putLock.unlock();
      }
  
      if (c == 0)
          signalNotEmpty();               // é¦–æ¬¡å…¥é˜Ÿï¼Œå”¤é†’ take
  }
  ```

  

- DelayQueue

  - 

- PriorityBlockingQueue

  - æ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ä»»åŠ¡æŒ‰ç…§å…¶è‡ªç„¶é¡ºåºæˆ–é€šè¿‡æ„é€ å™¨ç»™å®šçš„ Comparator æ¥æ’åºã€‚

- SynchronousQueue

  - å®é™…ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œå› ä¸ºæ²¡æœ‰å®¹é‡ã€‚æ¯ä¸ªæ’å…¥æ“ä½œ(`put()`)å¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç§»é™¤(`get()`)æ“ä½œï¼ŒåŒæ ·ä»»ä½•ä¸€ä¸ªç§»é™¤æ“ä½œéƒ½å¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ’å…¥æ“ä½œã€‚




## ArrayBlockingQueueå’ŒLinkedBlockingQueueå“ªä¸ªæ€§èƒ½é«˜

LinkedBlockingQueueæ€§èƒ½é«˜

`ArrayBlockingQueue` ä½¿ç”¨æ•°ç»„å’Œä¸€æŠŠé”ï¼Œç»“æ„ç®€å•ä½†æ€§èƒ½æœ‰é™ï¼›
 `LinkedBlockingQueue` ä½¿ç”¨é“¾è¡¨å’Œè¯»å†™åˆ†ç¦»é”ï¼Œååé‡æ›´é«˜ï¼Œé€‚åˆé«˜å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—ã€‚



## çº¿ç¨‹æ± çš„shutdown()å’ŒshutdownNow()åŒºåˆ«

**shutdown()**

- çº¿ç¨‹æ± å˜ä¸ºSHUTDOWNçŠ¶æ€
- çº¿ç¨‹æ± ä¸èƒ½åœ¨æ¥æ”¶æ–°çš„ä»»åŠ¡
- å·²ç»æäº¤çš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬å½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰ä»ç„¶ä¼šæ‰§è¡Œï¼Œéƒ½æ‰§è¡Œå®Œåçº¿ç¨‹æ± æ‰çœŸæ­£å…³é—­
- æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ç»§ç»­è¿è¡Œï¼Œä¸ä¼šè¢«ä¸­æ–­



**shutdownNow()**

- çº¿ç¨‹æ± å˜ä¸ºSTOPçŠ¶æ€
- çº¿ç¨‹æ± ä¸èƒ½åœ¨æ¥å—æ–°ä»»åŠ¡
- å½“å‰é˜Ÿåˆ—ä¸­çš„ä¼šè¢«ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œ
- æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šè¢«`interrupt()`ä¸­æ–­

æœ€ç»ˆçº¿ç¨‹æ± éƒ½ä¼šå˜æˆTERMINATEDçŠ¶æ€



## çº¿ç¨‹æ± æäº¤execute()å’Œsubmit()æœ‰ä»€ä¹ˆåŒºåˆ«

1. `execute()`ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡

   ```java
   threadPool.execute(new Runnable() {
      @Override
       public void run() {
           // TODO
       }
   });
   ```

   

2. `submit()`ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ªfutureç±»å‹çš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡futureçš„getæ–¹æ³•è·å–è¿”å›å€¼ã€‚

   ```java
   Future<Object> future = executor.submit(ReturnValueTask);
   try{
       Object s = future.get();
   } catch(Exception e){
       // æ•è·å¼‚å¸¸
   }
   ```



## ä¸¤ä¸ªçº¿ç¨‹æ± ä¹‹é—´è¦è¿›è¡Œä»»åŠ¡çš„åŒæ­¥ï¼Œæ€ä¹ˆåš

**1. ä½¿ç”¨Future.get()é˜»å¡ç­‰å¾…ç¬¬ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå®Œæ¯•**

```java
import java.util.concurrent.*;

public class FutureSyncExample {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        ExecutorService poolA = Executors.newFixedThreadPool(2);
        ExecutorService poolB = Executors.newFixedThreadPool(2);

        Future<String> futureA = poolA.submit(() -> {
            Thread.sleep(1000);
            return "Task A Done";
        });

        // ç­‰å¾… poolA ä»»åŠ¡å®Œæˆåå†æ‰§è¡Œ poolB ä»»åŠ¡
        String resultA = futureA.get(); // é˜»å¡ç­‰å¾…
        System.out.println(resultA);

        Future<String> futureB = poolB.submit(() -> "Task B Done");
        System.out.println(futureB.get());

        poolA.shutdown();
        poolB.shutdown();
    }
}
```



**2. ä½¿ç”¨CountDownLatch**

```java
import java.util.concurrent.*;

public class LatchExample {
    public static void main(String[] args) throws InterruptedException {
        ExecutorService poolA = Executors.newFixedThreadPool(2);
        ExecutorService poolB = Executors.newFixedThreadPool(2);

        CountDownLatch latch = new CountDownLatch(2);

        poolA.execute(() -> {
            try { Thread.sleep(1000); } catch (InterruptedException ignored) {}
            System.out.println("Task A Done");
            latch.countDown();
        });

        poolA.execute(() -> {
            try { Thread.sleep(1000); } catch (InterruptedException ignored) {}
            System.out.println("Task A2 Done");
            latch.countDown();
        });

        // ç­‰å¾… poolA æ‰§è¡Œå®Œæ¯•
        latch.await();

        // å¼€å§‹æ‰§è¡Œ poolB
        poolB.execute(() -> System.out.println("Task B Started"));

        poolA.shutdown();
        poolB.shutdown();
    }
}
```





## çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šçº¿ç¨‹æ± æ‰§è¡Œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-66.png)

å½“ä»»åŠ¡æäº¤æ—¶ï¼ŒThreadPoolExecutor çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š

1. å¦‚æœå½“å‰çº¿ç¨‹æ•° < corePoolSize
   - **ç›´æ¥åˆ›å»ºæ–°çº¿ç¨‹** æ¥æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯è¿›å…¥é˜Ÿåˆ—ã€‚
2. å¦‚æœå½“å‰çº¿ç¨‹æ•° â‰¥ corePoolSize
   - ä»»åŠ¡è¢«æ·»åŠ åˆ°**ä»»åŠ¡é˜Ÿåˆ—ï¼ˆworkQueueï¼‰**ï¼Œç­‰å¾…çº¿ç¨‹æ‰§è¡Œã€‚
3. å¦‚æœä»»åŠ¡é˜Ÿåˆ—æ»¡äº†
   - **å¦‚æœçº¿ç¨‹æ•° < maxPoolSize**ï¼Œå°±**åˆ›å»ºæ–°çº¿ç¨‹** å¤„ç†ä»»åŠ¡ã€‚
4. å¦‚æœçº¿ç¨‹æ•°è¾¾åˆ° maxPoolSizeï¼Œå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†
   - ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œæ‰§è¡Œ**æ‹’ç»ç­–ç•¥**ã€‚



ThreadPoolExecutor åªä¼šåœ¨æœ‰ä»»åŠ¡æäº¤æ—¶æ‰åˆ›å»ºçº¿ç¨‹ï¼Œå³ä¸ä¼šåœ¨åˆ›å»ºçº¿ç¨‹æ± æ—¶ç«‹å³åˆ›å»º corePoolSizeä¸ªçº¿ç¨‹ã€‚



## çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°åº”è¯¥æ€ä¹ˆé…ç½®

é¦–å…ˆåˆ†æçº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ç±»å‹æ˜¯ CPU å¯†é›†å‹è¿˜æ˜¯ IO å¯†é›†å‹

- å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯å°½é‡å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥ä¼˜åŒ– CPU ä½¿ç”¨ç‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸ºå¤„ç†å™¨çš„æ ¸å¿ƒæ•°æˆ–æ ¸å¿ƒæ•°åŠ ä¸€ï¼ˆä»¥å¤‡ä¸æ—¶ä¹‹éœ€ï¼Œå¦‚æŸäº›çº¿ç¨‹å› ç­‰å¾…ç³»ç»Ÿèµ„æºè€Œé˜»å¡æ—¶ï¼‰æ˜¯è¾ƒç†æƒ³çš„é€‰æ‹©ã€‚
  - å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ•°æ¥è¿‘ CPU æ ¸å¿ƒæ•°å³å¯

- å¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œç”±äºçº¿ç¨‹ç»å¸¸å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆç­‰å¾… IO æ“ä½œå®Œæˆï¼‰ï¼Œå¯ä»¥è®¾ç½®æ›´å¤šçš„çº¿ç¨‹æ¥æé«˜å¹¶å‘æ€§ï¼ˆæ¯”å¦‚è¯´ 2 å€ï¼‰ï¼Œä»è€Œå¢åŠ  CPU åˆ©ç”¨ç‡ã€‚
  - å¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ•°å¯ä»¥ç®€å•è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° Ã— 2ã€‚



## å¦‚ä½•çŸ¥é“è®¾ç½®çš„çº¿ç¨‹æ•°å¤šäº†è¿˜æ˜¯å°‘äº†

å¯ä»¥å…ˆé€šè¿‡ top å‘½ä»¤è§‚å¯Ÿ CPU çš„ä½¿ç”¨ç‡ï¼Œå¦‚æœ CPU ä½¿ç”¨ç‡è¾ƒä½ï¼Œå¯èƒ½æ˜¯çº¿ç¨‹æ•°è¿‡å°‘ï¼›å¦‚æœ CPU ä½¿ç”¨ç‡æ¥è¿‘ 100%ï¼Œä½†ååé‡æœªæå‡ï¼Œå¯èƒ½æ˜¯çº¿ç¨‹æ•°è¿‡å¤šã€‚



## çº¿ç¨‹æ± æ€ä¹ˆå¤„ç†å¼‚å¸¸

é—®é¢˜ï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æŠ›å‡ºå¼‚å¸¸ä¸ä¼šè¢«ä¸»çº¿ç¨‹æ•è·

```java
ExecutorService executor = Executors.newFixedThreadPool(2);
executor.execute(() -> {
    throw new RuntimeException("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸");
});
System.out.println("ä¸»çº¿ç¨‹ä¸ä¼šå—åˆ°å½±å“");
executor.shutdown();
```

**1. ä½¿ç”¨try-catchåœ¨ä»»åŠ¡å†…éƒ¨æ•è·å¼‚å¸¸**

**2. ä½¿ç”¨ Future è·å–å¼‚å¸¸ï¼ˆé€‚ç”¨äº `submit()`ï¼‰**

```java
ExecutorService executor = Executors.newFixedThreadPool(2);
Future<?> future = executor.submit(() -> {
    throw new RuntimeException("ä»»åŠ¡å¼‚å¸¸");
});

try {
    future.get(); // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå¦‚æœæœ‰å¼‚å¸¸ï¼Œä¼šåœ¨è¿™é‡ŒæŠ›å‡º ExecutionException
} catch (InterruptedException | ExecutionException e) {
    System.out.println("æ•è·å¼‚å¸¸ï¼š" + e.getCause().getMessage());
}
executor.shutdown();

```

**3. è‡ªå®šä¹‰ ThreadFactory æ•è·å¼‚å¸¸**

```java
ExecutorService executor = Executors.newFixedThreadPool(2, runnable -> {
    Thread thread = new Thread(runnable);
    thread.setUncaughtExceptionHandler((t, e) -> 
        System.out.println("çº¿ç¨‹ " + t.getName() + " æ•è·å¼‚å¸¸ï¼š" + e.getMessage()));
    return thread;
});

executor.execute(() -> {
    throw new RuntimeException("çº¿ç¨‹æ± ä»»åŠ¡å¼‚å¸¸");
});

executor.shutdown();

```

**4. é‡å†™ `ThreadPoolExecutor.afterExecute()` æ–¹æ³•**

```java
public class AfterExecuteExample extends ThreadPoolExecutor {
    public AfterExecuteExample(int corePoolSize, int maxPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue<Runnable> workQueue) {
        super(corePoolSize, maxPoolSize, keepAliveTime, unit, workQueue);
    }

    @Override
    protected void afterExecute(Runnable r, Throwable t) {
        super.afterExecute(r, t);
        if (t == null && r instanceof Future<?>) {
            try {
                ((Future<?>) r).get(); // æ•è· submit() ä»»åŠ¡çš„å¼‚å¸¸
            } catch (InterruptedException | ExecutionException e) {
                t = e.getCause();
            }
        }
        if (t != null) {
            System.out.println("æ•è·çº¿ç¨‹æ± å¼‚å¸¸ï¼š" + t.getMessage());
        }
    }
}
```



## çº¿ç¨‹æ± åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„ä»€ä¹ˆ

**1. é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ± å¤§å°**

- **è¿‡å°**çš„çº¿ç¨‹æ± å¯èƒ½ä¼šå¯¼è‡´ä»»åŠ¡ä¸€ç›´åœ¨æ’é˜Ÿ
- **è¿‡å¤§**çš„çº¿ç¨‹æ± å¯èƒ½ä¼šå¯¼è‡´å¤§å®¶éƒ½åœ¨ç«äº‰ CPU èµ„æºï¼Œå¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€

**2. ä»»åŠ¡é˜Ÿåˆ—çš„é€‰æ‹©**

- ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å¯ä»¥é¿å…èµ„æºè€—å°½çš„é£é™©ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´ä»»åŠ¡è¢«æ‹’ç»
- ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—è™½ç„¶å¯ä»¥é¿å…ä»»åŠ¡è¢«æ‹’ç»ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´å†…å­˜è€—å°½

**3. å°½é‡ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± **

- newFixedThreadPool çº¿ç¨‹æ± ç”±äºä½¿ç”¨äº† LinkedBlockingQueueï¼Œé˜Ÿåˆ—çš„å®¹é‡é»˜è®¤æ— é™å¤§ï¼Œå®é™…ä½¿ç”¨ä¸­å‡ºç°ä»»åŠ¡è¿‡å¤šæ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡º
- newCachedThreadPool çº¿ç¨‹æ± ç”±äºæ ¸å¿ƒçº¿ç¨‹æ•°æ— é™å¤§ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ä¼šå¯¼è‡´åˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯èƒ½æœºå™¨è´Ÿè½½è¿‡é«˜å¯¼è‡´æœåŠ¡å®•æœº



## å¦‚ä½•è‡ªå·±è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± 

```java
package caogao;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.HashSet;
import java.util.Set;

public class MyThreadPool {
}

/**
 * è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆæ”¯æŒ corePoolSizeã€maximumPoolSize å’Œ keepAliveTimeï¼‰
 */
class CustomThreadPool {
    private final int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ•°
    private final int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ•°
    private final long keepAliveTime; // æœ€å¤§çº¿ç¨‹çš„å­˜æ´»æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    private final BlockingQueue<Runnable> taskQueue; // ä»»åŠ¡é˜Ÿåˆ—
    private final Set<Worker> workers = new HashSet<>(); // å­˜æ´»çš„çº¿ç¨‹é›†åˆ
    private final AtomicBoolean isShutdown = new AtomicBoolean(false); // çº¿ç¨‹æ± çŠ¶æ€

    public CustomThreadPool(int corePoolSize, int maximumPoolSize, long keepAliveTime) {
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.keepAliveTime = keepAliveTime;
        this.taskQueue = new LinkedBlockingQueue<>();
    }

    /**
     * æäº¤ä»»åŠ¡
     */
    public synchronized void submit(Runnable task) {
        if (isShutdown.get()) {
            throw new IllegalStateException("çº¿ç¨‹æ± å·²å…³é—­ï¼Œæ— æ³•æäº¤ä»»åŠ¡");
        }

        // 1. çº¿ç¨‹æ•°å°äº corePoolSizeï¼Œåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
        if (workers.size() < corePoolSize) {
            addWorker(task, true);
        }
        // 2. ä»»åŠ¡é˜Ÿåˆ—æœªæ»¡ï¼ŒåŠ å…¥é˜Ÿåˆ—
        else if (!taskQueue.offer(task)) {
            // 3. ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œå°è¯•åˆ›å»ºé¢å¤–çº¿ç¨‹ï¼ˆä¸è¶…è¿‡ maximumPoolSizeï¼‰
            if (workers.size() < maximumPoolSize) {
                addWorker(task, false);
            } else {
                throw new RuntimeException("ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•å¤„ç†æ›´å¤šä»»åŠ¡ï¼");
            }
        }
    }

    /**
     * æ·»åŠ æ–°çº¿ç¨‹åˆ°çº¿ç¨‹æ± 
     */
    private void addWorker(Runnable firstTask, boolean isCore) {
        Worker worker = new Worker(firstTask, isCore);
        workers.add(worker);
        worker.start();
    }

    /**
     * å…³é—­çº¿ç¨‹æ± ï¼ˆç­‰å¾…ä»»åŠ¡å®Œæˆï¼‰
     */
    public synchronized void shutdown() {
        isShutdown.set(true);
    }

    /**
     * ç«‹å³å…³é—­çº¿ç¨‹æ± ï¼ˆæ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—ï¼‰
     */
    public synchronized void shutdownNow() {
        isShutdown.set(true);
        taskQueue.clear();
        for (Worker worker : workers) {
            worker.interrupt();
        }
    }

    /**
     * çº¿ç¨‹æ± ä¸­çš„ Worker çº¿ç¨‹
     */
    private class Worker extends Thread {
        private Runnable initialTask;
        private final boolean isCore; // æ˜¯å¦ä¸ºæ ¸å¿ƒçº¿ç¨‹

        public Worker(Runnable task, boolean isCore) {
            this.initialTask = task;
            this.isCore = isCore;
        }

        @Override
        public void run() {
            try {
                // 1. å…ˆæ‰§è¡Œæäº¤æ—¶çš„ä»»åŠ¡
                if (initialTask != null) {
                    initialTask.run();
                    initialTask = null;
                }

                // 2. ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡æ‰§è¡Œ
                while (!isShutdown.get()) {
                    Runnable task = isCore ? taskQueue.take() : taskQueue.poll(keepAliveTime, TimeUnit.MILLISECONDS);
                    if (task != null) {
                        task.run();
                    } else {
                        break; // éæ ¸å¿ƒçº¿ç¨‹åœ¨è¶…æ—¶æ—¶é”€æ¯
                    }
                }
            } catch (InterruptedException e) {
                // çº¿ç¨‹ç»ˆæ­¢
            } finally {
                synchronized (CustomThreadPool.this) {
                    workers.remove(this); // çº¿ç¨‹é€€å‡ºæ—¶ç§»é™¤
                }
            }
        }
    }
}

```





## å•æœºçº¿ç¨‹æ± æ‰§è¡Œæ—¶æ–­ç”µäº†æ€ä¹ˆå¤„ç†

å¯¹é˜»å¡é˜Ÿåˆ—æŒä¹…åŒ–ï¼›æ­£åœ¨å¤„ç†ä»»åŠ¡äº‹åŠ¡æ§åˆ¶ï¼›æ–­ç”µä¹‹åæ­£åœ¨å¤„ç†ä»»åŠ¡çš„å›æ»šï¼Œé€šè¿‡æ—¥å¿—æ¢å¤è¯¥æ¬¡æ“ä½œï¼›æœåŠ¡å™¨é‡å¯åé˜»å¡é˜Ÿåˆ—ä¸­çš„æ•°æ®å†åŠ è½½ã€‚



## ä¸ºä»€ä¹ˆä¸æ¨èç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± 

å› ä¸ºä½¿ç”¨Excecutorsåˆ›å»ºçº¿ç¨‹æ± é»˜è®¤çš„çº¿ç¨‹æ± å‚æ•°ä¸å¤Ÿçµæ´»ï¼Œå…¶é»˜è®¤å‚æ•°å¯èƒ½ä¼šå¯¼è‡´èµ„æºè€—å°½ï¼Œå¼•å‘OOMæˆ–ä»»åŠ¡å †ç§¯

**Executors.newFixedThreadPool(n)**

- **é»˜è®¤æ— ç•Œé˜Ÿåˆ—**ï¼Œå¯èƒ½å¯¼è‡´ä»»åŠ¡å †ç§¯ï¼Œå†…å­˜æº¢å‡ºï¼ˆOOMï¼‰



**Executors.newCachedThreadPool()**

- **æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE`ï¼ˆ2^31-1ï¼‰**ï¼Œé«˜å¹¶å‘æ—¶å¯èƒ½æ— é™åˆ›å»ºçº¿ç¨‹ï¼Œå¯¼è‡´ CPU è´Ÿè½½è¿‡é«˜æˆ– å†…å­˜æº¢å‡º



# å¹¶å‘å·¥å…·ç±»

## HashMapæœ‰å“ªäº›çº¿ç¨‹å®‰å…¨é—®é¢˜

**JDK7 HashMapå¹¶å‘æ­»é“¾**

å› ä¸ºJDK7ä¸­çš„HashMapæ‰©å®¹æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯å¤´æ’æ³•ï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰©å®¹å®Œäº†åï¼Œç”±äºèŠ‚ç‚¹é“¾è¡¨å·²ç»æ”¹å˜ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†è¿›è¡Œæ“ä½œå°±å¯èƒ½ä¼šäº§ç”Ÿå¾ªç¯é“¾è¡¨ï¼Œæ­»å¾ªç¯ã€‚



## HashMapå’ŒConcurrentHashMapçš„åŒºåˆ«

- HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹åº”è¯¥ä½¿ç”¨ ConcurrentHashMapã€‚
- ç”±äº HashMap ä»…åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘åŒæ­¥é—®é¢˜ï¼Œå› æ­¤æ•ˆç‡é«˜äº ConcurrentHashMapã€‚



## ConcurrentHashMapçš„åŸç†

- JDK 7

  ![åˆå¿µåˆæ‹ï¼šJDK 7 ConcurrentHashMap](https://cdn.tobebetterjavaer.com/stutymore/map-20230816155810.png)

  - é‡‡ç”¨çš„æ˜¯åˆ†æ®µé”æœºåˆ¶ï¼ˆSegment Lockingï¼‰ï¼Œæ•´ä¸ªMapè¢«åˆ†ä¸ºè‹¥å¹²æ®µï¼Œæ¯ä¸ªæ®µéƒ½å¯ä»¥ç‹¬ç«‹åœ°åŠ é”ã€‚å› æ­¤ï¼Œä¸åŒçº¿ç¨‹å¯ä»¥åŒæ—¶æ“ä½œä¸åŒçš„æ®µï¼Œä»è€Œå®ç°å¹¶å‘è®¿é—®ã€‚

  - **putæ–¹æ³•æµç¨‹**ï¼šConcurrentHashMap çš„ put æµç¨‹å’Œ HashMap éå¸¸ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯å…ˆå®šä½åˆ°å…·ä½“çš„ Segmentï¼Œç„¶åé€šè¿‡ ReentrantLock å»æ“ä½œè€Œå·²ã€‚

    1. è®¡ç®— hashï¼Œå®šä½åˆ° segmentï¼Œsegment å¦‚æœæ˜¯ç©ºå°±å…ˆåˆå§‹åŒ–ï¼›
    2. ä½¿ç”¨ ReentrantLock åŠ é”ï¼Œå¦‚æœè·å–é”å¤±è´¥åˆ™å°è¯•è‡ªæ—‹ï¼Œè‡ªæ—‹è¶…è¿‡æ¬¡æ•°å°±é˜»å¡è·å–ï¼Œä¿è¯ä¸€å®šèƒ½è·å–åˆ°é”ï¼›
    3. éå† HashEntryï¼Œkey ç›¸åŒå°±ç›´æ¥æ›¿æ¢ï¼Œä¸å­˜åœ¨å°±æ’å…¥ã€‚
    4. é‡Šæ”¾é”ã€‚

    <img src="https://cdn.tobebetterjavaer.com/stutymore/javathread-20240325113351.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šJDK7 put æµç¨‹" style="zoom: 33%;" />

  - **getæ–¹æ³•æµç¨‹**ï¼šget ä¹Ÿå¾ˆç®€å•ï¼Œé€šè¿‡ `hash(key)` å®šä½åˆ° segmentï¼Œå†éå†é“¾è¡¨å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ value æ˜¯ volatile çš„ï¼Œæ‰€ä»¥ get æ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚

    

- JDK 8ä»¥å

  ![åˆå¿µåˆæ‹ï¼šJDK 8 ConcurrentHashMap](https://cdn.tobebetterjavaer.com/stutymore/map-20230816155924.png)

  - åœ¨JDK8åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸å†ä½¿ç”¨åˆ†æ®µé”ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§æ›´åŠ ç²¾ç»†åŒ–çš„é”â€”æ¡¶é”ï¼Œä»¥åŠCASæ— é”ç®—æ³•ã€‚æ¯ä¸ªæ¡¶ï¼ˆNode æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼‰éƒ½å¯ä»¥ç‹¬ç«‹åœ°åŠ é”ï¼Œä»è€Œå®ç°æ›´é«˜çº§åˆ«çš„å¹¶å‘è®¿é—®ã€‚
  - å¯¹äºè¯»æ“ä½œï¼Œé€šå¸¸ä¸éœ€è¦åŠ é”ï¼Œå¯ä»¥ç›´æ¥è¯»å–ï¼ŒConcurrentHashMap å†…éƒ¨ä½¿ç”¨äº† volatile å˜é‡æ¥ä¿è¯å†…å­˜å¯è§æ€§ã€‚
  - å¯¹äºå†™æ“ä½œï¼ŒConcurrentHashMap ä½¿ç”¨ CAS æ“ä½œæ¥å®ç°æ— é”çš„æ›´æ–°ï¼Œè¿™æ˜¯ä¸€ç§ä¹è§‚é”çš„å®ç°ï¼Œå› ä¸ºå®ƒå‡è®¾æ²¡æœ‰å†²çªå‘ç”Ÿï¼Œåœ¨å®é™…æ›´æ–°æ•°æ®æ—¶æ‰æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹åœ¨å°è¯•ä¿®æ”¹æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œé‡‡ç”¨æ‚²è§‚çš„é”ç­–ç•¥ï¼Œå¦‚ synchronized ä»£ç å—æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚
  - **putæ–¹æ³•æµç¨‹ï¼š**é€šè¿‡è®¡ç®—é”®çš„å“ˆå¸Œå€¼ç¡®å®šå­˜å‚¨ä½ç½®ï¼Œå¦‚æœæ¡¶ä¸ºç©ºï¼Œä½¿ç”¨ CAS æ’å…¥èŠ‚ç‚¹ï¼›å¦‚æœå­˜åœ¨å†²çªï¼Œé€šè¿‡é“¾è¡¨æˆ–çº¢é»‘æ ‘æ’å…¥ã€‚åœ¨å†²çªæ—¶ï¼Œå¦‚æœ CAS æ“ä½œå¤±è´¥ï¼Œä¼šé€€åŒ–ä¸º synchronized æ“ä½œã€‚å†™æ“ä½œå¯èƒ½è§¦å‘æ‰©å®¹æˆ–é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ï¼ˆå½“é“¾è¡¨é•¿åº¦è¶…è¿‡3/4æ—¶è¿›è¡Œæ‰©å®¹ï¼Œå½“é“¾è¡¨é•¿åº¦è¶…è¿‡ 8 å°±è½¬æ¢æˆçº¢é»‘æ ‘ï¼‰ã€‚
  - ![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šJava 8 put æµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-32.jpg)
  - **get æ–¹æ³•æµç¨‹**ï¼šé€šè¿‡è®¡ç®—å“ˆå¸Œå€¼å¿«é€Ÿå®šä½æ¡¶ï¼Œåœ¨æ¡¶ä¸­æŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹ï¼Œå¤šä¸ª key å€¼æ—¶é“¾è¡¨éå†å’Œçº¢é»‘æ ‘æŸ¥æ‰¾ã€‚è¯»æ“ä½œæ˜¯æ— é”çš„ï¼Œä¾èµ– volatile ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚



## CountDownLatchäº†è§£å—

ç”¨äºåè°ƒå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆã€‚

- åˆå§‹åŒ–ï¼šåˆ›å»º CountDownLatch å¯¹è±¡æ—¶ï¼ŒæŒ‡å®šè®¡æ•°å™¨çš„åˆå§‹å€¼ã€‚
- ç­‰å¾…ï¼ˆawaitï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼å˜ä¸ºé›¶ã€‚
- å€’è®¡æ•°ï¼ˆcountDownï¼‰ï¼šå…¶ä»–çº¿ç¨‹åœ¨å®Œæˆå„è‡ªä»»åŠ¡åè°ƒç”¨ countDown æ–¹æ³•ï¼Œå°†è®¡æ•°å™¨çš„å€¼å‡ä¸€ã€‚å½“è®¡æ•°å™¨çš„å€¼å‡åˆ°é›¶æ—¶ï¼Œæ‰€æœ‰åœ¨ await ä¸Šç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œã€‚



## CyclicBarrierï¼ˆåŒæ­¥å±éšœï¼‰äº†è§£å—

è®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚

![CyclicBarrierå·¥ä½œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-55.png)

## CyclicBarrierå’ŒCountDownLatchæœ‰ä»€ä¹ˆåŒºåˆ«

- CountDownLatch æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè€Œ CyclicBarrier åˆ™å¯ä»¥å¤šæ¬¡è®¾ç½®å±éšœï¼Œå®ç°é‡å¤åˆ©ç”¨ï¼›
- CountDownLatch ä¸­çš„å„ä¸ªå­çº¿ç¨‹ä¸å¯ä»¥ç­‰å¾…å…¶ä»–çº¿ç¨‹ï¼Œåªèƒ½å®Œæˆè‡ªå·±çš„ä»»åŠ¡ï¼›è€Œ CyclicBarrier ä¸­çš„å„ä¸ªçº¿ç¨‹å¯ä»¥ç­‰å¾…å…¶ä»–çº¿ç¨‹

- åœ¨ CyclicBarrier ä¸­ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹é‡åˆ°äº†ä¸­æ–­ã€è¶…æ—¶ç­‰é—®é¢˜æ—¶ï¼Œåˆ™å¤„äº await çš„çº¿ç¨‹éƒ½ä¼šå‡ºç°é—®é¢˜ï¼›åœ¨ CountDownLatch ä¸­ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹å‡ºç°é—®é¢˜ï¼Œå…¶ä»–çº¿ç¨‹ä¸å—å½±å“

## Semaphoreï¼ˆä¿¡å·é‡ï¼‰äº†è§£å—

Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºã€‚

![Semaphoreè®¸å¯è·å–-æ¥æºå‚è€ƒ[18]](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-57.jpeg)

## Exchangeräº†è§£å—

Exchangerï¼ˆäº¤æ¢è€…ï¼‰æ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ã€‚Exchanger ç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢ã€‚å®ƒæä¾›ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œåœ¨è¿™ä¸ªåŒæ­¥ç‚¹ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯ä»¥äº¤æ¢å½¼æ­¤çš„æ•°æ®ã€‚



```java
import java.util.concurrent.Exchanger;

public class ExchangerDemo {
    public static void main(String[] args) {
        Exchanger<String> exchanger = new Exchanger<>();

        new Thread(() -> {
            try {
                String data = "æ•°æ® A";
                System.out.println(Thread.currentThread().getName() + " å‘é€æ•°æ®ï¼š" + data);
                String received = exchanger.exchange(data);
                System.out.println(Thread.currentThread().getName() + " æ”¶åˆ°æ•°æ®ï¼š" + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            try {
                String data = "æ•°æ® B";
                System.out.println(Thread.currentThread().getName() + " å‘é€æ•°æ®ï¼š" + data);
                String received = exchanger.exchange(data);
                System.out.println(Thread.currentThread().getName() + " æ”¶åˆ°æ•°æ®ï¼š" + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "çº¿ç¨‹ 2").start();
    }
}
```



## CopyOnWriteArrayListçš„å®ç°åŸç†

CopyOnWriteArrayList æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ ArrayListï¼Œå®ƒéµå¾ªå†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰çš„åŸåˆ™ï¼Œå³åœ¨å†™æ“ä½œæ—¶ï¼Œä¼šå…ˆå¤åˆ¶ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œç„¶ååœ¨æ–°çš„æ•°ç»„ä¸Šè¿›è¡Œå†™æ“ä½œï¼Œå†™å®Œä¹‹åå†å°†åŸæ•°ç»„å¼•ç”¨æŒ‡å‘æ–°æ•°ç»„ã€‚

![CL0610ï¼šæœ€ç»ˆä¸€è‡´æ€§](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/CopyOnWriteArrayList-01.png)

- è¯»å†™åˆ†ç¦»ï¼Œåœ¨å†™æ“ä½œä¸Šä½¿ç”¨SynchronizedåŠ é”ï¼Œè¯»æ“ä½œä¸Šä¸åŠ é”
  - å†™æ“ä½œ ä¼š åˆ›å»ºæ–°å‰¯æœ¬ å¹¶ ä¿®æ”¹æ•°æ®ï¼Œä½†å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚
- è¯»æ“ä½œå¼±ä¸€è‡´æ€§
- **é€‚ç”¨äºâ€œè¯»å¤šå†™å°‘â€çš„åœºæ™¯**ï¼Œå¦‚æœéœ€è¦**å®æ—¶ä¸€è‡´æ€§**ï¼Œåº”è¯¥ç”¨ synchronizedæˆ– ConcurrentHashMapã€‚



## BlockingQueueæ˜¯ä»€ä¹ˆ

æ˜¯çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—

- **å½“é˜Ÿåˆ—ä¸ºç©º**ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ï¼ˆ`take()`ï¼‰ä¼š **è‡ªåŠ¨é˜»å¡**ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ å¯å–ã€‚

- **å½“é˜Ÿåˆ—æ»¡äº†**ï¼Œç”Ÿäº§è€…çº¿ç¨‹ï¼ˆ`put()`ï¼‰ä¼š **è‡ªåŠ¨é˜»å¡**ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½å¯ç”¨ã€‚



## BlockingQueueçš„å®ç°åŸç†

**put()**

- å…ˆè·å–é” `lock.lockInterruptibly()`ã€‚
- å¦‚æœé˜Ÿåˆ— **å·²æ»¡**ï¼Œè°ƒç”¨ `notFull.await()` **é˜»å¡**ï¼Œç­‰å¾… `take()` å”¤é†’ã€‚
- å½“ `take()` æ¶ˆè´¹ä¸€ä¸ªå…ƒç´ ï¼Œè°ƒç”¨ `notFull.signal()` å”¤é†’ `put()` çº¿ç¨‹ã€‚

**take()**

- å…ˆè·å–é” `lock.lockInterruptibly()`ã€‚
- å¦‚æœé˜Ÿåˆ— **ä¸ºç©º**ï¼Œè°ƒç”¨ `notEmpty.await()` **é˜»å¡**ï¼Œç­‰å¾… `put()` å”¤é†’ã€‚
- å½“ `put()` æ”¾å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè°ƒç”¨ `notEmpty.signal()` å”¤é†’ `take()` çº¿ç¨‹ã€‚



## Fork / Joinæ¡†æ¶äº†è§£å—





## Fork/Joinæ¡†æ¶ä¸ThreadPoolExecutorçš„åŒºåˆ«ï¼Ÿ
ä¸»è¦åŒºåˆ«åœ¨äºä»»åŠ¡è°ƒåº¦æœºåˆ¶ã€‚

- ThreadPoolExecutorä½¿ç”¨å•ä¸€çš„å…±äº«é˜Ÿåˆ—

- è€ŒFork/Joinä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„åŒç«¯é˜Ÿåˆ—ï¼Œå¯ä»¥çªƒå–å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ï¼Œæ›´é€‚åˆå¤„ç†é€’å½’åˆ†æ²»çš„ä»»åŠ¡ã€‚

  

## ä»€ä¹ˆæ˜¯å·¥ä½œçªƒå–ç®—æ³•ï¼Ÿ
![å·¥ä½œçªƒå–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/javathread-86.png)

å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—æœ«å°¾çªƒå–ä»»åŠ¡æ‰§è¡Œï¼Œå®ç°äº†æ›´å¥½çš„è´Ÿè½½å‡è¡¡ï¼Œæé«˜äº†CPUåˆ©ç”¨ç‡



## å‚è€ƒèµ„æ–™

[é»‘é©¬ç¨‹åºå‘˜JUCå¹¶å‘ç¼–ç¨‹æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd?spm_id_from=333.788.videopod.episodes&vd_source=40110d1722fdce829e736c2a08fb55ae)ï¼š

- P11 - 15 ï¼ˆåˆ›å»ºçº¿ç¨‹ï¼‰
- p44 - 46 ï¼ˆçº¿ç¨‹çŠ¶æ€ï¼‰
- p78 - 87 ï¼ˆSynchronizedä¼˜åŒ–åŸç†ï¼‰
- p120 - 127 ï¼ˆReentrantLockï¼‰
- p146 - 151 ï¼ˆvolatileåŸç†ï¼‰
- P200 - 219 ï¼ˆä»è‡ªå®šä¹‰çº¿ç¨‹æ± åˆ°ThreadPoolExecutorï¼‰
- P274 - 296 ï¼ˆConcurrentHashMapï¼‰



[Javaé¢æ¸£](https://javabetter.cn/sidebar/sanfene/javathread.html#)





